<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vazifalar Boshqaruvi</title>
    <style>
        :root {
            --primary: #667eea;
            --primary-dark: #5568d3;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --bg-main: #f5f5f5;
            --bg-card: #ffffff;
            --text-main: #333;
            --text-secondary: #6c757d;
            --border: #e0e0e0;
        }

        [data-theme="dark"] {
            --bg-main: #1a1a1a;
            --bg-card: #2d2d2d;
            --text-main: #e0e0e0;
            --text-secondary: #a0a0a0;
            --border: #404040;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-main);
            min-height: 100vh;
            padding: 10px;
            color: var(--text-main);
            transition: all 0.3s ease;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .user-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
            flex-wrap: wrap;
            gap: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary);
        }

        .user-name {
            font-size: 16px;
            font-weight: 600;
        }

        .login-btn, .logout-btn {
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .login-btn:hover, .logout-btn:hover {
            background: var(--primary-dark);
        }

        .login-btn:disabled, .logout-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 8px 15px;
            background: var(--bg-main);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: var(--border);
        }

        .header h1 {
            color: var(--primary);
            font-size: 28px;
            margin-bottom: 15px;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: var(--bg-main);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .search-wrapper {
            position: relative;
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px 12px 40px;
            font-size: 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            outline: none;
            background: var(--bg-card);
            color: var(--text-main);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .new-list-section {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .new-list-input {
            flex: 1;
            min-width: 200px;
            padding: 12px 15px;
            font-size: 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            outline: none;
            background: var(--bg-card);
            color: var(--text-main);
        }

        .new-list-input.error {
            border-color: var(--danger);
        }

        .new-list-btn {
            padding: 12px 25px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
        }

        .new-list-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .lists-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .list-card {
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            position: relative;
        }

        .list-card.shared {
            border: 2px solid var(--success);
        }

        .list-card.loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            gap: 10px;
        }

        .list-title-edit {
            font-size: 20px;
            font-weight: bold;
            border: none;
            background: transparent;
            flex: 1;
            padding: 5px;
            color: var(--text-main);
            border-radius: 6px;
        }

        .list-title-edit:focus {
            outline: 2px solid var(--primary);
        }

        .delete-list-btn {
            padding: 6px 10px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }

        .task-input-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 12px 0;
        }

        .task-input-row {
            display: flex;
            gap: 8px;
        }

        .task-input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-main);
            font-size: 14px;
        }

        .task-input.error {
            border-color: var(--danger);
        }

        .deadline-input {
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-main);
            font-size: 13px;
            cursor: pointer;
        }

        .add-task-btn {
            padding: 10px 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            white-space: nowrap;
        }

        .add-task-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .tasks-list {
            list-style: none;
            max-height: 500px;
            overflow-y: auto;
        }

        .task-item {
            background: var(--bg-main);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 3px solid transparent;
        }

        .task-item.completed {
            opacity: 0.6;
        }

        .task-item.priority-low { border-left-color: #6c757d; }
        .task-item.priority-medium { border-left-color: #ffc107; }
        .task-item.priority-high { border-left-color: #ff6b35; }
        .task-item.priority-critical { border-left-color: #dc3545; }

        .task-header {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 8px;
        }

        .star-btn {
            font-size: 16px;
            cursor: pointer;
            color: #ddd;
        }

        .star-btn.starred {
            color: #ffc107;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            min-width: 20px;
            border: 2px solid var(--primary);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-top: 2px;
        }

        .task-item.completed .checkbox {
            background: var(--primary);
        }

        .task-item.completed .checkbox::after {
            content: '‚úì';
            color: white;
            font-weight: bold;
        }

        .task-content {
            flex: 1;
            min-width: 0;
        }

        .task-text-edit {
            width: 100%;
            font-size: 14px;
            padding: 4px;
            border: none;
            background: transparent;
            color: var(--text-main);
            border-radius: 4px;
            word-wrap: break-word;
        }

        .task-text-edit:focus {
            outline: 2px solid var(--primary);
            background: var(--bg-card);
        }

        .task-item.completed .task-text-edit {
            text-decoration: line-through;
            color: var(--text-secondary);
        }

        .task-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
            font-size: 12px;
        }

        .task-deadline {
            color: var(--text-secondary);
        }

        .task-deadline.overdue {
            color: var(--danger);
            font-weight: 600;
        }

        .task-file {
            color: var(--primary);
            text-decoration: none;
        }

        .task-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .priority-select, .status-select {
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 11px;
            border: 1px solid var(--border);
            cursor: pointer;
            font-weight: 600;
        }

        .priority-low { background: #6c757d; color: white; }
        .priority-medium { background: #ffc107; color: black; }
        .priority-high { background: #ff6b35; color: white; }
        .priority-critical { background: #dc3545; color: white; }

        .status-backlog { background: #6c757d; color: white; }
        .status-todo { background: #007bff; color: white; }
        .status-progress { background: #ffc107; color: black; }
        .status-review { background: #17a2b8; color: white; }
        .status-done { background: #28a745; color: white; }
        .status-hold { background: #dc3545; color: white; }

        .file-input-label {
            padding: 4px 10px;
            background: var(--primary);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
            display: inline-block;
        }

        .file-input-label.uploading {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .file-input {
            display: none;
        }

        .delete-task-btn {
            padding: 4px 10px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
        }

        .share-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid var(--border);
        }

        .share-input-group {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .share-email-input {
            flex: 1;
            min-width: 150px;
            padding: 8px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background: var(--bg-card);
            color: var(--text-main);
            font-size: 13px;
        }

        .share-email-input.error {
            border-color: var(--danger);
        }

        .permission-select {
            padding: 8px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background: var(--bg-card);
            color: var(--text-main);
            font-size: 13px;
        }

        .share-btn {
            padding: 8px 16px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
        }

        .share-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .shared-users {
            margin-top: 10px;
        }

        .shared-user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: var(--bg-main);
            border-radius: 6px;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .permission-badge {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }

        .perm-viewer { background: #17a2b8; color: white; }
        .perm-executor { background: #ffc107; color: black; }
        .perm-creator { background: #28a745; color: white; }

        .no-lists {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .sync-notice {
            background: var(--warning);
            color: #000;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
            display: none;
        }

        .error-notice {
            background: var(--danger);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
            display: none;
        }

        .success-notice {
            background: var(--success);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
            display: none;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-text {
            color: var(--danger);
            font-size: 12px;
            margin-top: 5px;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }

            .header {
                padding: 15px;
            }

            .header h1 {
                font-size: 22px;
            }

            .lists-container {
                grid-template-columns: 1fr;
            }

            .user-section {
                flex-direction: column;
                align-items: flex-start;
            }

            .theme-toggle {
                width: 100%;
                justify-content: center;
            }

            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }

            .task-actions {
                width: 100%;
            }

            .priority-select, .status-select {
                flex: 1;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 20px;
            }

            .new-list-section {
                flex-direction: column;
            }

            .new-list-input {
                width: 100%;
            }

            .new-list-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body data-theme="light">
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="main-container">
        <div class="header">
            <div class="user-section">
                <div class="user-info" id="userInfo">
                    <button class="login-btn" id="loginBtn">Google orqali kirish</button>
                </div>
                <div class="theme-toggle" onclick="toggleTheme()">
                    <span id="themeIcon">üåô</span>
                    <span id="themeText">Qorong'i rejim</span>
                </div>
            </div>

            <div class="sync-notice" id="syncNotice">
                ‚ö†Ô∏è Siz offline rejimda ishlayapsiz. Ma'lumotlar faqat shu qurilmada saqlanadi. Google orqali kiring va ma'lumotlaringiz bulutda saqlansin.
            </div>

            <div class="error-notice" id="errorNotice"></div>
            <div class="success-notice" id="successNotice"></div>

            <h1>üìã Vazifalar Boshqaruvi</h1>

            <div class="stats-bar">
                <div class="stat-card">
                    <div class="stat-number" id="totalTasks">0</div>
                    <div class="stat-label">Jami</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedTasks">0</div>
                    <div class="stat-label">Bajarilgan</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendingTasks">0</div>
                    <div class="stat-label">Kutilmoqda</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completionRate">0%</div>
                    <div class="stat-label">Foiz</div>
                </div>
            </div>

            <div class="search-wrapper">
                <span class="search-icon">üîç</span>
                <input type="text" id="searchInput" class="search-input" placeholder="Vazifalarni qidirish...">
            </div>
            
            <div class="new-list-section">
                <input type="text" id="newListInput" class="new-list-input" placeholder="Yangi ro'yxat nomi...">
                <button id="newListBtn" class="new-list-btn">+ Yaratish</button>
            </div>
        </div>

        <div id="listsContainer" class="lists-container"></div>
        <div id="noLists" class="no-lists" style="display: none;">
            <div style="font-size: 60px; margin-bottom: 15px;">üìù</div>
            <p>Hozircha ro'yxatlar yo'q. Yuqorida yangi ro'yxat yarating!</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-database-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-storage-compat.min.js"></script>

    <script>
        // ===== FIREBASE CONFIGURATION =====
        // MUHIM: Production muhitda bu configni environment variables yoki secure backend'dan oling
        // Bu faqat demo maqsadida. Real loyihada Firebase Security Rules ni to'g'ri sozlang!
        const firebaseConfig = {
            apiKey: "AIzaSyCwtHihZq8qFRCaCs2tJBC16cPG-bUWho0",
            authDomain: "checkbox-5b848.firebaseapp.com",
            databaseURL: "https://checkbox-5b848-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "checkbox-5b848",
            storageBucket: "checkbox-5b848.firebasestorage.app",
            messagingSenderId: "461550771942",
            appId: "1:461550771942:web:53def1224b2f8ded95e527",
            measurementId: "G-1VHZ91HQ72"
        };

        // Firebase initialization with error handling
        let database, auth, storage, provider;
        
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            auth = firebase.auth();
            storage = firebase.storage();
            provider = new firebase.auth.GoogleAuthProvider();
        } catch (error) {
            console.error('Firebase initialization error:', error);
            showError('Firebase ishga tushurishda xatolik yuz berdi');
        }

        // ===== GLOBAL VARIABLES =====
        let currentUser = null;
        let lists = [];
        let searchQuery = '';
        let isOnlineMode = false;
        let syncedListIds = new Set(); // Dublikatlarni oldini olish uchun

        // ===== UTILITY FUNCTIONS =====
        
        function showLoading(show = true) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.add('active');
            } else {
                overlay.classList.remove('active');
            }
        }

        function showError(message, duration = 5000) {
            const notice = document.getElementById('errorNotice');
            notice.textContent = message;
            notice.style.display = 'block';
            setTimeout(() => {
                notice.style.display = 'none';
            }, duration);
        }

        function showSuccess(message, duration = 3000) {
            const notice = document.getElementById('successNotice');
            notice.textContent = message;
            notice.style.display = 'block';
            setTimeout(() => {
                notice.style.display = 'none';
            }, duration);
        }

        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email.toLowerCase());
        }

        function sanitizeInput(input) {
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }

        function validateFileSize(file, maxSizeMB = 10) {
            const maxSize = maxSizeMB * 1024 * 1024;
            return file.size <= maxSize;
        }

        function validateFileType(file, allowedTypes = ['image/*', 'application/pdf', '.doc', '.docx', '.txt']) {
            // Basic file type validation
            return true; // Bu yerda kerakli file type validation qo'shing
        }

        // ===== THEME FUNCTIONS =====
        
        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', newTheme);
            document.getElementById('themeIcon').textContent = newTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            document.getElementById('themeText').textContent = newTheme === 'light' ? 'Qorong\'i rejim' : 'Yorug\' rejim';
            
            try {
                localStorage.setItem('theme', newTheme);
            } catch (error) {
                console.error('Theme save error:', error);
            }
        }

        // Load saved theme
        try {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                toggleTheme();
            }
        } catch (error) {
            console.error('Theme load error:', error);
        }

        // ===== SEARCH FUNCTION =====
        
        document.getElementById('searchInput').addEventListener('input', (e) => {
            searchQuery = e.target.value.toLowerCase();
            renderLists();
        });

        // ===== AUTHENTICATION =====
        
        document.getElementById('loginBtn').addEventListener('click', async () => {
            const btn = document.getElementById('loginBtn');
            btn.disabled = true;
            btn.textContent = 'Yuklanmoqda...';
            showLoading(true);
            
            try {
                await auth.signInWithPopup(provider);
                showSuccess('Muvaffaqiyatli kirdingiz!');
            } catch (error) {
                console.error('Login error:', error);
                let errorMessage = 'Kirishda xatolik yuz berdi!';
                
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = 'Kirish bekor qilindi';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = 'Internet aloqasi yo\'q';
                } else if (error.code === 'auth/unauthorized-domain') {
                    errorMessage = 'Bu domen uchun avtorizatsiya yo\'q';
                }
                
                showError(errorMessage);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Google orqali kirish';
                showLoading(false);
            }
        });

        auth.onAuthStateChanged(user => {
            currentUser = user;
            updateUserUI();
            
            if (user) {
                isOnlineMode = true;
                document.getElementById('syncNotice').style.display = 'none';
                syncLocalToFirebase();
                loadLists();
            } else {
                isOnlineMode = false;
                document.getElementById('syncNotice').style.display = 'block';
                loadLocalLists();
            }
        });

        function updateUserUI() {
            const userInfo = document.getElementById('userInfo');
            if (currentUser) {
                userInfo.innerHTML = `
                    <img src="${currentUser.photoURL}" class="user-avatar" alt="Avatar" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2245%22 height=%2245%22><rect width=%22100%%22 height=%22100%%22 fill=%22%23667eea%22/><text x=%2250%%22 y=%2250%%22 font-size=%2220%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22white%22>${currentUser.displayName.charAt(0)}</text></svg>'">
                    <div>
                        <div class="user-name">${sanitizeInput(currentUser.displayName)}</div>
                        <div style="font-size: 11px; color: var(--text-secondary)">${sanitizeInput(currentUser.email)}</div>
                    </div>
                    <button class="logout-btn" onclick="logout()">Chiqish</button>
                `;
            }
        }

        function logout() {
            if (confirm('Chiqishdan oldin ma\'lumotlaringiz saqlanganligiga ishonchingiz komilmi?')) {
                showLoading(true);
                auth.signOut().then(() => {
                    lists = [];
                    syncedListIds.clear();
                    renderLists();
                    showSuccess('Chiqish muvaffaqiyatli!');
                }).catch(error => {
                    console.error('Logout error:', error);
                    showError('Chiqishda xatolik yuz berdi');
                }).finally(() => {
                    showLoading(false);
                });
            }
        }

        // ===== LOCAL STORAGE FUNCTIONS =====
        
        function saveToLocal() {
            try {
                localStorage.setItem('localLists', JSON.stringify(lists));
            } catch (error) {
                console.error('Local save error:', error);
                if (error.name === 'QuotaExceededError') {
                    showError('Xotira to\'ldi! Ba\'zi ma\'lumotlar saqlanmadi.');
                }
            }
        }

        function loadLocalLists() {
            try {
                const saved = localStorage.getItem('localLists');
                lists = saved ? JSON.parse(saved) : [];
                updateStats();
                renderLists();
            } catch (error) {
                console.error('Local load error:', error);
                showError('Lokal ma\'lumotlarni yuklashda xatolik');
                lists = [];
            }
        }

        async function syncLocalToFirebase() {
            try {
                const localData = localStorage.getItem('localLists');
                if (localData && currentUser) {
                    const localLists = JSON.parse(localData);
                    if (localLists.length > 0) {
                        if (confirm(`Sizda ${localLists.length} ta offline ro\'yxat bor. Ularni bulutga yuklashni xohlaysizmi?`)) {
                            showLoading(true);
                            
                            for (const list of localLists) {
                                // Dublikat tekshirish
                                const listHash = `${list.title}_${list.createdAt}`;
                                if (!syncedListIds.has(listHash)) {
                                    try {
                                        await database.ref(`users/${currentUser.uid}/lists`).push({
                                            ...list,
                                            owner: currentUser.uid,
                                            ownerName: currentUser.displayName,
                                            createdAt: list.createdAt || Date.now(),
                                            syncedAt: Date.now()
                                        });
                                        syncedListIds.add(listHash);
                                    } catch (error) {
                                        console.error('Sync error for list:', error);
                                    }
                                }
                            }
                            
                            localStorage.removeItem('localLists');
                            showSuccess('Ma\'lumotlar muvaffaqiyatli yuklandi!');
                        }
                    }
                }
            } catch (error) {
                console.error('Sync error:', error);
                showError('Sync qilishda xatolik yuz berdi');
            } finally {
                showLoading(false);
            }
        }

        // ===== FIREBASE DATA LOADING =====
        
        function loadLists() {
            if (!currentUser) return;

            try {
                database.ref(`users/${currentUser.uid}/lists`).on('value', snapshot => {
                    const privateLists = [];
                    const data = snapshot.val();
                    
                    if (data) {
                        Object.keys(data).forEach(key => {
                            privateLists.push({ ...data[key], id: key, isShared: false });
                        });
                    }
                    
                    database.ref('sharedLists').once('value', sharedSnapshot => {
                        const sharedLists = [];
                        const sharedData = sharedSnapshot.val();
                        
                        if (sharedData) {
                            Object.keys(sharedData).forEach(key => {
                                const list = sharedData[key];
                                if (list.owner === currentUser.uid || 
                                    (list.sharedWith && list.sharedWith[currentUser.email.replace(/\./g, '_')])) {
                                    sharedLists.push({ ...list, id: key, isShared: true });
                                }
                            });
                        }
                        
                        lists = [...privateLists, ...sharedLists];
                        updateStats();
                        renderLists();
                    }, error => {
                        console.error('Shared lists load error:', error);
                        showError('Ulashilgan ro\'yxatlarni yuklashda xatolik');
                    });
                }, error => {
                    console.error('Lists load error:', error);
                    showError('Ro\'yxatlarni yuklashda xatolik');
                });
            } catch (error) {
                console.error('Load lists error:', error);
                showError('Ma\'lumotlarni yuklashda xatolik');
            }
        }

        // ===== STATISTICS =====
        
        function updateStats() {
            let total = 0;
            let completed = 0;

            lists.forEach(list => {
                if (list.tasks) {
                    total += list.tasks.length;
                    completed += list.tasks.filter(t => t.completed).length;
                }
            });

            const pending = total - completed;
            const rate = total > 0 ? Math.round((completed / total) * 100) : 0;

            document.getElementById('totalTasks').textContent = total;
            document.getElementById('completedTasks').textContent = completed;
            document.getElementById('pendingTasks').textContent = pending;
            document.getElementById('completionRate').textContent = rate + '%';
        }

        // ===== RENDER FUNCTIONS =====
        
        function renderLists() {
            const container = document.getElementById('listsContainer');
            const noLists = document.getElementById('noLists');

            let filteredLists = lists;
            
            if (searchQuery) {
                filteredLists = lists.filter(list => {
                    const titleMatch = list.title.toLowerCase().includes(searchQuery);
                    const taskMatch = list.tasks && list.tasks.some(task => 
                        task.text.toLowerCase().includes(searchQuery)
                    );
                    return titleMatch || taskMatch;
                });
            }

            if (filteredLists.length === 0) {
                container.innerHTML = '';
                noLists.style.display = 'block';
                return;
            }

            noLists.style.display = 'none';
            container.innerHTML = '';

            filteredLists.forEach(list => {
                try {
                    const card = createListCard(list);
                    container.appendChild(card);
                } catch (error) {
                    console.error('Render list error:', error);
                }
            });
        }

        function createListCard(list) {
            const card = document.createElement('div');
            card.className = `list-card ${list.isShared ? 'shared' : ''}`;

            const permission = getPermission(list);
            const canEdit = permission === 'creator' || !isOnlineMode;
            const canCheck = permission !== 'viewer' || !isOnlineMode;

            const sortedTasks = (list.tasks || []).sort((a, b) => {
                if (a.starred !== b.starred) return a.starred ? -1 : 1;
                if (a.completed === b.completed) return 0;
                return a.completed ? 1 : -1;
            });

            card.innerHTML = `
                <div class="list-header">
                    <input type="text" class="list-title-edit" value="${sanitizeInput(list.title)}" 
                        ${canEdit ? '' : 'readonly'} 
                        onblur="updateListTitle('${list.id}', this.value, ${list.isShared})"
                        maxlength="100">
                    ${canEdit ? `<button class="delete-list-btn" onclick="deleteList('${list.id}', ${list.isShared})">üóëÔ∏è</button>` : ''}
                </div>
                
                ${canEdit ? `
                <div class="task-input-section">
                    <div class="task-input-row">
                        <input type="text" class="task-input" id="taskInput${list.id}" placeholder="Yangi vazifa..." maxlength="500">
                        <input type="date" class="deadline-input" id="deadlineInput${list.id}">
                    </div>
                    <button class="add-task-btn" onclick="addTask('${list.id}', ${list.isShared})">+ Qo'shish</button>
                </div>` : ''}
                
                <ul class="tasks-list" id="tasksList${list.id}"></ul>
                
                ${canEdit && list.isShared && isOnlineMode ? `
                <div class="share-section">
                    <strong>üë• Ulashish:</strong>
                    <div class="share-input-group">
                        <input type="email" class="share-email-input" id="shareEmail${list.id}" placeholder="Email manzili">
                        <select class="permission-select" id="sharePerm${list.id}">
                            <option value="viewer">Kuzatuvchi</option>
                            <option value="executor">Bajaruvchi</option>
                            <option value="creator">Yaratuvchi</option>
                        </select>
                        <button class="share-btn" onclick="shareList('${list.id}')">Ulashish</button>
                    </div>
                    <div class="shared-users" id="sharedUsers${list.id}"></div>
                </div>` : ''}
            `;

            const tasksList = card.querySelector(`#tasksList${list.id}`);
            sortedTasks.forEach((task, index) => {
                if (!searchQuery || task.text.toLowerCase().includes(searchQuery)) {
                    try {
                        const taskItem = createTaskItem(task, index, list.id, list.isShared, canCheck, canEdit);
                        tasksList.appendChild(taskItem);
                    } catch (error) {
                        console.error('Create task item error:', error);
                    }
                }
            });

            if (list.isShared && list.sharedWith) {
                setTimeout(() => renderSharedUsers(list), 0);
            }

            return card;
        }

        function createTaskItem(task, index, listId, isShared, canCheck, canEdit) {
            const li = document.createElement('li');
            li.className = `task-item ${task.completed ? 'completed' : ''} priority-${task.priority || 'medium'}`;

            const now = new Date();
            const deadline = task.deadline ? new Date(task.deadline) : null;
            const isOverdue = deadline && deadline < now && !task.completed;

            li.innerHTML = `
                <div class="task-header">
                    ${canEdit ? `<span class="star-btn ${task.starred ? 'starred' : ''}" onclick="toggleStar('${listId}', ${index}, ${isShared})">‚≠ê</span>` : ''}
                    <div class="checkbox" ${canCheck ? `onclick="toggleTask('${listId}', ${index}, ${isShared})"` : ''}></div>
                    <div class="task-content">
                        <input type="text" class="task-text-edit" value="${sanitizeInput(task.text)}" 
                            ${canEdit ? '' : 'readonly'}
                            onblur="updateTaskText('${listId}', ${index}, this.value, ${isShared})"
                            maxlength="500">
                        <div class="task-meta">
                            ${task.deadline ? `<span class="task-deadline ${isOverdue ? 'overdue' : ''}">üìÖ ${formatDate(task.deadline)} ${isOverdue ? '‚ö†Ô∏è' : ''}</span>` : ''}
                            ${task.fileName ? `<a href="${task.fileUrl}" class="task-file" target="_blank" download="${sanitizeInput(task.fileName)}">üìé ${sanitizeInput(task.fileName)}</a>` : ''}
                        </div>
                    </div>
                </div>
                <div class="task-actions">
                    ${canEdit ? `
                    <select class="priority-select priority-${task.priority || 'medium'}" 
                        onchange="updateTaskPriority('${listId}', ${index}, this.value, ${isShared})">
                        <option value="low" ${task.priority === 'low' ? 'selected' : ''}>Past</option>
                        <option value="medium" ${!task.priority || task.priority === 'medium' ? 'selected' : ''}>O'rta</option>
                        <option value="high" ${task.priority === 'high' ? 'selected' : ''}>Yuqori</option>
                        <option value="critical" ${task.priority === 'critical' ? 'selected' : ''}>Kritik</option>
                    </select>
                    ` : ''}
                    <select class="status-select status-${task.status || 'todo'}" 
                        ${canEdit ? '' : 'disabled'}
                        onchange="updateTaskStatus('${listId}', ${index}, this.value, ${isShared})">
                        <option value="backlog" ${task.status === 'backlog' ? 'selected' : ''}>Backlog</option>
                        <option value="todo" ${!task.status || task.status === 'todo' ? 'selected' : ''}>To Do</option>
                        <option value="progress" ${task.status === 'progress' ? 'selected' : ''}>In Progress</option>
                        <option value="review" ${task.status === 'review' ? 'selected' : ''}>Review</option>
                        <option value="done" ${task.status === 'done' ? 'selected' : ''}>Done</option>
                    </select>
                    ${canEdit ? `
                    <label class="file-input-label" id="fileLabel${listId}${index}">
                        üìé Fayl
                        <input type="file" class="file-input" onchange="uploadFile('${listId}', ${index}, this, ${isShared})" 
                            accept="image/*,.pdf,.doc,.docx,.txt,.xlsx,.xls,.zip">
                    </label>
                    <button class="delete-task-btn" onclick="deleteTask('${listId}', ${index}, ${isShared})">üóëÔ∏è</button>
                    ` : ''}
                </div>
            `;

            return li;
        }

        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const taskDate = new Date(date);
                taskDate.setHours(0, 0, 0, 0);

                const diff = (taskDate - today) / (1000 * 60 * 60 * 24);

                if (diff === 0) return 'Bugun';
                if (diff === 1) return 'Ertaga';
                if (diff === -1) return 'Kecha';
                
                return date.toLocaleDateString('uz-UZ', { day: 'numeric', month: 'short' });
            } catch (error) {
                console.error('Date format error:', error);
                return dateString;
            }
        }

        function getPermission(list) {
            if (!isOnlineMode) return 'creator';
            if (!currentUser) return 'viewer';
            if (list.owner === currentUser.uid) return 'creator';
            if (list.sharedWith && list.sharedWith[currentUser.email.replace(/\./g, '_')]) {
                return list.sharedWith[currentUser.email.replace(/\./g, '_')];
            }
            return 'viewer';
        }

        // ===== DATA OPERATIONS =====
        
        async function saveData(listId, isShared) {
            try {
                if (isOnlineMode) {
                    const list = lists.find(l => l.id === listId);
                    if (!list) return;
                    
                    const path = isShared ? `sharedLists/${listId}` : `users/${currentUser.uid}/lists/${listId}`;
                    await database.ref(path).set(list);
                } else {
                    saveToLocal();
                }
                updateStats();
            } catch (error) {
                console.error('Save data error:', error);
                showError('Ma\'lumotlarni saqlashda xatolik');
            }
        }

        async function updateListTitle(listId, newTitle, isShared) {
            const title = newTitle.trim();
            if (!title) {
                showError('Ro\'yxat nomi bo\'sh bo\'lishi mumkin emas');
                renderLists();
                return;
            }
            
            if (title.length > 100) {
                showError('Ro\'yxat nomi 100 belgidan oshmasligi kerak');
                return;
            }
            
            try {
                const list = lists.find(l => l.id === listId);
                if (!list) return;
                
                list.title = title;
                
                if (isOnlineMode) {
                    const path = isShared ? `sharedLists/${listId}/title` : `users/${currentUser.uid}/lists/${listId}/title`;
                    await database.ref(path).set(title);
                } else {
                    saveToLocal();
                }
            } catch (error) {
                console.error('Update title error:', error);
                showError('Nomni yangilashda xatolik');
            }
        }

        async function deleteList(listId, isShared) {
            if (!confirm('Rostdan ham bu ro\'yxatni o\'chirmoqchimisiz? Bu amalni ortga qaytarib bo\'lmaydi!')) return;
            
            try {
                showLoading(true);
                
                if (isOnlineMode) {
                    const path = isShared ? `sharedLists/${listId}` : `users/${currentUser.uid}/lists/${listId}`;
                    await database.ref(path).remove();
                    showSuccess('Ro\'yxat o\'chirildi');
                } else {
                    lists = lists.filter(l => l.id !== listId);
                    saveToLocal();
                    renderLists();
                    showSuccess('Ro\'yxat o\'chirildi');
                }
            } catch (error) {
                console.error('Delete list error:', error);
                showError('Ro\'yxatni o\'chirishda xatolik');
            } finally {
                showLoading(false);
            }
        }

        async function createList() {
            const input = document.getElementById('newListInput');
            const title = input.value.trim();

            if (!title) {
                input.classList.add('error');
                showError('Ro\'yxat nomini kiriting');
                setTimeout(() => input.classList.remove('error'), 2000);
                return;
            }

            if (title.length > 100) {
                showError('Ro\'yxat nomi 100 belgidan oshmasligi kerak');
                return;
            }

            try {
                const btn = document.getElementById('newListBtn');
                btn.disabled = true;
                showLoading(true);

                const newList = {
                    title: sanitizeInput(title),
                    tasks: [],
                    createdAt: Date.now()
                };

                if (isOnlineMode) {
                    newList.owner = currentUser.uid;
                    newList.ownerName = currentUser.displayName;
                    await database.ref(`users/${currentUser.uid}/lists`).push(newList);
                    showSuccess('Ro\'yxat yaratildi');
                } else {
                    newList.id = 'list_' + Date.now();
                    lists.push(newList);
                    saveToLocal();
                    renderLists();
                    showSuccess('Ro\'yxat yaratildi');
                }

                input.value = '';
            } catch (error) {
                console.error('Create list error:', error);
                showError('Ro\'yxat yaratishda xatolik');
            } finally {
                document.getElementById('newListBtn').disabled = false;
                showLoading(false);
            }
        }

        async function addTask(listId, isShared) {
            const input = document.getElementById(`taskInput${listId}`);
            const deadlineInput = document.getElementById(`deadlineInput${listId}`);
            const text = input.value.trim();
            
            if (!text) {
                input.classList.add('error');
                showError('Vazifa matnini kiriting');
                setTimeout(() => input.classList.remove('error'), 2000);
                return;
            }

            if (text.length > 500) {
                showError('Vazifa matni 500 belgidan oshmasligi kerak');
                return;
            }

            try {
                const list = lists.find(l => l.id === listId);
                if (!list) return;
                
                if (!list.tasks) list.tasks = [];
                
                const newTask = {
                    text: sanitizeInput(text),
                    completed: false,
                    status: 'todo',
                    priority: 'medium',
                    starred: false,
                    createdAt: Date.now()
                };

                if (isOnlineMode) {
                    newTask.createdBy = currentUser.uid;
                }

                if (deadlineInput.value) {
                    newTask.deadline = deadlineInput.value;
                }

                list.tasks.push(newTask);
                await saveData(listId, isShared);
                
                input.value = '';
                deadlineInput.value = '';
                renderLists();
            } catch (error) {
                console.error('Add task error:', error);
                showError('Vazifa qo\'shishda xatolik');
            }
        }

        async function updateTaskText(listId, index, newText, isShared) {
            const text = newText.trim();
            if (!text) {
                showError('Vazifa matni bo\'sh bo\'lishi mumkin emas');
                renderLists();
                return;
            }
            
            if (text.length > 500) {
                showError('Vazifa matni 500 belgidan oshmasligi kerak');
                return;
            }
            
            try {
                const list = lists.find(l => l.id === listId);
                if (!list || !list.tasks[index]) return;
                
                list.tasks[index].text = sanitizeInput(text);
                await saveData(listId, isShared);
            } catch (error) {
                console.error('Update task text error:', error);
                showError('Vazifa matnini yangilashda xatolik');
            }
        }

        async function toggleTask(listId, index, isShared) {
            try {
                const list = lists.find(l => l.id === listId);
                if (!list || !list.tasks[index]) return;
                
                list.tasks[index].completed = !list.tasks[index].completed;
                await saveData(listId, isShared);
                renderLists();
            } catch (error) {
                console.error('Toggle task error:', error);
                showError('Vazifa holatini o\'zgartirishda xatolik');
            }
        }

        async function toggleStar(listId, index, isShared) {
            try {
                const list = lists.find(l => l.id === listId);
                if (!list || !list.tasks[index]) return;
                
                list.tasks[index].starred = !list.tasks[index].starred;
                await saveData(listId, isShared);
                renderLists();
            } catch (error) {
                console.error('Toggle star error:', error);
                showError('Yulduzcha qo\'yishda xatolik');
            }
        }

        async function updateTaskStatus(listId, index, status, isShared) {
            try {
                const list = lists.find(l => l.id === listId);
                if (!list || !list.tasks[index]) return;
                
                list.tasks[index].status = status;
                await saveData(listId, isShared);
            } catch (error) {
                console.error('Update status error:', error);
                showError('Statusni yangilashda xatolik');
            }
        }

        async function updateTaskPriority(listId, index, priority, isShared) {
            try {
                const list = lists.find(l => l.id === listId);
                if (!list || !list.tasks[index]) return;
                
                list.tasks[index].priority = priority;
                await saveData(listId, isShared);
                renderLists();
            } catch (error) {
                console.error('Update priority error:', error);
                showError('Prioritetni yangilashda xatolik');
            }
        }

        async function uploadFile(listId, index, input, isShared) {
            const file = input.files[0];
            if (!file) return;

            // File size validation
            if (!validateFileSize(file, 10)) {
                showError('Fayl hajmi 10MB dan kichik bo\'lishi kerak!');
                input.value = '';
                return;
            }

            const label = document.getElementById(`fileLabel${listId}${index}`);
            
            try {
                label.classList.add('uploading');
                label.textContent = 'Yuklanmoqda...';
                
                const list = lists.find(l => l.id === listId);
                if (!list || !list.tasks[index]) return;
                
                if (isOnlineMode) {
                    const storageRef = storage.ref(`files/${currentUser.uid}/${Date.now()}_${file.name}`);
                    const snapshot = await storageRef.put(file);
                    const url = await snapshot.ref.getDownloadURL();
                    
                    list.tasks[index].fileUrl = url;
                    list.tasks[index].fileName = file.name;
                    await saveData(listId, isShared);
                    showSuccess('Fayl yuklandi');
                } else {
                    // Offline mode - base64
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        list.tasks[index].fileUrl = e.target.result;
                        list.tasks[index].fileName = file.name;
                        saveToLocal();
                        renderLists();
                        showSuccess('Fayl yuklandi');
                    };
                    reader.onerror = function() {
                        showError('Faylni o\'qishda xatolik');
                    };
                    reader.readAsDataURL(file);
                }
                
                renderLists();
            } catch (error) {
                console.error('Upload file error:', error);
                showError('Fayl yuklashda xatolik');
            } finally {
                if (label) {
                    label.classList.remove('uploading');
                    label.textContent = 'üìé Fayl';
                }
                input.value = '';
            }
        }

        async function deleteTask(listId, index, isShared) {
            if (!confirm('Bu vazifani o\'chirmoqchimisiz?')) return;
            
            try {
                const list = lists.find(l => l.id === listId);
                if (!list) return;
                
                list.tasks.splice(index, 1);
                await saveData(listId, isShared);
                renderLists();
                showSuccess('Vazifa o\'chirildi');
            } catch (error) {
                console.error('Delete task error:', error);
                showError('Vazifani o\'chirishda xatolik');
            }
        }

        async function shareList(listId) {
            const emailInput = document.getElementById(`shareEmail${listId}`);
            const email = emailInput.value.trim();
            const permission = document.getElementById(`sharePerm${listId}`).value;

            if (!email) {
                emailInput.classList.add('error');
                showError('Email manzilini kiriting');
                setTimeout(() => emailInput.classList.remove('error'), 2000);
                return;
            }

            if (!validateEmail(email)) {
                emailInput.classList.add('error');
                showError('Email manzili noto\'g\'ri');
                setTimeout(() => emailInput.classList.remove('error'), 2000);
                return;
            }

            if (email === currentUser.email) {
                showError('O\'zingizga ulasha olmaysiz');
                return;
            }

            try {
                const btn = document.querySelector(`#shareEmail${listId}`).nextElementSibling.nextElementSibling;
                btn.disabled = true;
                
                await database.ref(`sharedLists/${listId}/sharedWith/${email.replace(/\./g, '_')}`).set(permission);
                emailInput.value = '';
                showSuccess('Ro\'yxat ulashildi');
            } catch (error) {
                console.error('Share list error:', error);
                showError('Ulashishda xatolik');
            } finally {
                const btn = document.querySelector(`#shareEmail${listId}`).nextElementSibling.nextElementSibling;
                if (btn) btn.disabled = false;
            }
        }

        function renderSharedUsers(list) {
            try {
                const container = document.getElementById(`sharedUsers${list.id}`);
                if (!container || !list.sharedWith) return;

                container.innerHTML = '';
                Object.keys(list.sharedWith).forEach(email => {
                    const perm = list.sharedWith[email];
                    const div = document.createElement('div');
                    div.className = 'shared-user-item';
                    div.innerHTML = `
                        <span>${sanitizeInput(email.replace(/_/g, '.'))}</span>
                        <span class="permission-badge perm-${perm}">
                            ${perm === 'viewer' ? 'Kuzatuvchi' : perm === 'executor' ? 'Bajaruvchi' : 'Yaratuvchi'}
                        </span>
                    `;
                    container.appendChild(div);
                });
            } catch (error) {
                console.error('Render shared users error:', error);
            }
        }

        // ===== EVENT LISTENERS =====
        
        document.getElementById('newListBtn').addEventListener('click', createList);
        
        document.getElementById('newListInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                createList();
            }
        });

        // ===== INITIALIZE =====
        
        // Handle online/offline status
        window.addEventListener('online', () => {
            if (currentUser && !isOnlineMode) {
                showSuccess('Internet aloqasi qayta ulandi');
                isOnlineMode = true;
                syncLocalToFirebase();
            }
        });

        window.addEventListener('offline', () => {
            if (isOnlineMode) {
                showError('Internet aloqasi yo\'q. Offline rejimda ishlayapsiz.');
                isOnlineMode = false;
            }
        });
    </script>
</body>
</html>
