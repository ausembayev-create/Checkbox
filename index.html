<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vazifalar Boshqaruvi</title>
    <style>
        :root {
            --primary: #667eea;
            --primary-dark: #5568d3;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --bg-main: #f5f5f5;
            --bg-card: #ffffff;
            --text-main: #333;
            --text-secondary: #6c757d;
            --border: #e0e0e0;
        }

        [data-theme="dark"] {
            --bg-main: #1a1a1a;
            --bg-card: #2d2d2d;
            --text-main: #e0e0e0;
            --text-secondary: #a0a0a0;
            --border: #404040;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-main);
            min-height: 100vh;
            padding: 10px;
            color: var(--text-main);
            transition: all 0.3s ease;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .user-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
            flex-wrap: wrap;
            gap: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary);
        }

        .user-name {
            font-size: 16px;
            font-weight: 600;
        }

        .login-btn, .logout-btn {
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .login-btn:hover, .logout-btn:hover {
            background: var(--primary-dark);
        }

        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 8px 15px;
            background: var(--bg-main);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: var(--border);
        }

        .header h1 {
            color: var(--primary);
            font-size: 28px;
            margin-bottom: 15px;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: var(--bg-main);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .search-wrapper {
            position: relative;
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px 12px 40px;
            font-size: 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            outline: none;
            background: var(--bg-card);
            color: var(--text-main);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .new-list-section {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .new-list-input {
            flex: 1;
            min-width: 200px;
            padding: 12px 15px;
            font-size: 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            outline: none;
            background: var(--bg-card);
            color: var(--text-main);
        }

        .new-list-btn {
            padding: 12px 25px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
        }

        .lists-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .list-card {
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        .list-card.shared {
            border: 2px solid var(--success);
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            gap: 10px;
        }

        .list-title-edit {
            font-size: 20px;
            font-weight: bold;
            border: none;
            background: transparent;
            flex: 1;
            padding: 5px;
            color: var(--text-main);
            border-radius: 6px;
        }

        .list-title-edit:focus {
            outline: 2px solid var(--primary);
        }

        .delete-list-btn {
            padding: 6px 10px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }

        .task-input-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 12px 0;
        }

        .task-input-row {
            display: flex;
            gap: 8px;
        }

        .task-input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-main);
            font-size: 14px;
        }

        .deadline-input {
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-main);
            font-size: 13px;
            cursor: pointer;
        }

        .add-task-btn {
            padding: 10px 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            white-space: nowrap;
        }

        .tasks-list {
            list-style: none;
            max-height: 500px;
            overflow-y: auto;
        }

        .task-item {
            background: var(--bg-main);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 3px solid transparent;
        }

        .task-item.completed {
            opacity: 0.6;
        }

        .task-item.priority-low { border-left-color: #6c757d; }
        .task-item.priority-medium { border-left-color: #ffc107; }
        .task-item.priority-high { border-left-color: #ff6b35; }
        .task-item.priority-critical { border-left-color: #dc3545; }

        .task-header {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 8px;
        }

        .star-btn {
            font-size: 16px;
            cursor: pointer;
            color: #ddd;
        }

        .star-btn.starred {
            color: #ffc107;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            min-width: 20px;
            border: 2px solid var(--primary);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-top: 2px;
        }

        .task-item.completed .checkbox {
            background: var(--primary);
        }

        .task-item.completed .checkbox::after {
            content: '‚úì';
            color: white;
            font-weight: bold;
        }

        .task-content {
            flex: 1;
            min-width: 0;
        }

        .task-text-edit {
            width: 100%;
            font-size: 14px;
            padding: 4px;
            border: none;
            background: transparent;
            color: var(--text-main);
            border-radius: 4px;
            word-wrap: break-word;
        }

        .task-text-edit:focus {
            outline: 2px solid var(--primary);
            background: var(--bg-card);
        }

        .task-item.completed .task-text-edit {
            text-decoration: line-through;
            color: var(--text-secondary);
        }

        .task-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
            font-size: 12px;
        }

        .task-deadline {
            color: var(--text-secondary);
        }

        .task-deadline.overdue {
            color: var(--danger);
            font-weight: 600;
        }

        .task-file {
            color: var(--primary);
            text-decoration: none;
        }

        .task-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .priority-select, .status-select {
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 11px;
            border: 1px solid var(--border);
            cursor: pointer;
            font-weight: 600;
        }

        .priority-low { background: #6c757d; color: white; }
        .priority-medium { background: #ffc107; color: black; }
        .priority-high { background: #ff6b35; color: white; }
        .priority-critical { background: #dc3545; color: white; }

        .status-backlog { background: #6c757d; color: white; }
        .status-todo { background: #007bff; color: white; }
        .status-progress { background: #ffc107; color: black; }
        .status-review { background: #17a2b8; color: white; }
        .status-done { background: #28a745; color: white; }
        .status-hold { background: #dc3545; color: white; }

        .file-input-label {
            padding: 4px 10px;
            background: var(--primary);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
            display: inline-block;
        }

        .file-input {
            display: none;
        }

        .delete-task-btn {
            padding: 4px 10px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
        }

        .share-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid var(--border);
        }

        .share-input-group {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .share-email-input {
            flex: 1;
            min-width: 150px;
            padding: 8px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background: var(--bg-card);
            color: var(--text-main);
            font-size: 13px;
        }

        .permission-select {
            padding: 8px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background: var(--bg-card);
            color: var(--text-main);
            font-size: 13px;
        }

        .share-btn {
            padding: 8px 16px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
        }

        .shared-users {
            margin-top: 10px;
        }

        .shared-user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: var(--bg-main);
            border-radius: 6px;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .permission-badge {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }

        .perm-viewer { background: #17a2b8; color: white; }
        .perm-executor { background: #ffc107; color: black; }
        .perm-creator { background: #28a745; color: white; }

        .no-lists {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .sync-notice {
            background: var(--warning);
            color: #000;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
            display: none;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }

            .header {
                padding: 15px;
            }

            .header h1 {
                font-size: 22px;
            }

            .lists-container {
                grid-template-columns: 1fr;
            }

            .user-section {
                flex-direction: column;
                align-items: flex-start;
            }

            .theme-toggle {
                width: 100%;
                justify-content: center;
            }

            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }

            .task-actions {
                width: 100%;
            }

            .priority-select, .status-select {
                flex: 1;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 20px;
            }

            .new-list-section {
                flex-direction: column;
            }

            .new-list-input {
                width: 100%;
            }

            .new-list-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body data-theme="light">
    <div class="main-container">
        <div class="header">
            <div class="user-section">
                <div class="user-info" id="userInfo">
                    <button class="login-btn" id="loginBtn">Google orqali kirish</button>
                </div>
                <div class="theme-toggle" onclick="toggleTheme()">
                    <span id="themeIcon">üåô</span>
                    <span id="themeText">Qorong'i rejim</span>
                </div>
            </div>

            <div class="sync-notice" id="syncNotice">
                ‚ö†Ô∏è Siz offline rejimda ishlayapsiz. Ma'lumotlar faqat shu qurilmada saqlanadi. Google orqali kiring va ma'lumotlaringiz bulutda saqlansin.
            </div>

            <h1>üìã Vazifalar Boshqaruvi</h1>

            <div class="stats-bar">
                <div class="stat-card">
                    <div class="stat-number" id="totalTasks">0</div>
                    <div class="stat-label">Jami</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedTasks">0</div>
                    <div class="stat-label">Bajarilgan</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendingTasks">0</div>
                    <div class="stat-label">Kutilmoqda</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completionRate">0%</div>
                    <div class="stat-label">Foiz</div>
                </div>
            </div>

            <div class="search-wrapper">
                <span class="search-icon">üîç</span>
                <input type="text" id="searchInput" class="search-input" placeholder="Vazifalarni qidirish...">
            </div>
            
            <div class="new-list-section">
                <input type="text" id="newListInput" class="new-list-input" placeholder="Yangi ro'yxat nomi...">
                <button id="newListBtn" class="new-list-btn">+ Yaratish</button>
            </div>
        </div>

        <div id="listsContainer" class="lists-container"></div>
        <div id="noLists" class="no-lists" style="display: none;">
            <div style="font-size: 60px; margin-bottom: 15px;">üìù</div>
            <p>Hozircha ro'yxatlar yo'q. Yuqorida yangi ro'yxat yarating!</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-database-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-storage-compat.min.js"></script>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCwtHihZq8qFRCaCs2tJBC16cPG-bUWho0",
            authDomain: "checkbox-5b848.firebaseapp.com",
            databaseURL: "https://checkbox-5b848-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "checkbox-5b848",
            storageBucket: "checkbox-5b848.firebasestorage.app",
            messagingSenderId: "461550771942",
            appId: "1:461550771942:web:53def1224b2f8ded95e527",
            measurementId: "G-1VHZ91HQ72"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        const storage = firebase.storage();
        const provider = new firebase.auth.GoogleAuthProvider();

        let currentUser = null;
        let lists = [];
        let searchQuery = '';
        let isOnlineMode = false;

        // Tema
        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', newTheme);
            document.getElementById('themeIcon').textContent = newTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            document.getElementById('themeText').textContent = newTheme === 'light' ? 'Qorong\'i rejim' : 'Yorug\' rejim';
            localStorage.setItem('theme', newTheme);
        }

        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            toggleTheme();
        }

        // Qidiruv
        document.getElementById('searchInput').addEventListener('input', (e) => {
            searchQuery = e.target.value.toLowerCase();
            renderLists();
        });

        // Google Authentication
        document.getElementById('loginBtn').addEventListener('click', () => {
            auth.signInWithPopup(provider).catch(err => {
                console.error('Login error:', err);
                alert('Kirishda xatolik yuz berdi!');
            });
        });

        auth.onAuthStateChanged(user => {
            currentUser = user;
            updateUserUI();
            
            if (user) {
                isOnlineMode = true;
                document.getElementById('syncNotice').style.display = 'none';
                syncLocalToFirebase();
                loadLists();
            } else {
                isOnlineMode = false;
                document.getElementById('syncNotice').style.display = 'block';
                loadLocalLists();
            }
        });

        function updateUserUI() {
            const userInfo = document.getElementById('userInfo');
            if (currentUser) {
                userInfo.innerHTML = `
                    <img src="${currentUser.photoURL}" class="user-avatar" alt="Avatar">
                    <div>
                        <div class="user-name">${currentUser.displayName}</div>
                        <div style="font-size: 11px; color: var(--text-secondary)">${currentUser.email}</div>
                    </div>
                    <button class="logout-btn" onclick="logout()">Chiqish</button>
                `;
            }
        }

        function logout() {
            if (confirm('Chiqishdan oldin ma\'lumotlaringiz saqlanganligiga ishonchingiz komilmi?')) {
                auth.signOut();
                lists = [];
                renderLists();
            }
        }

        // Local Storage funksiyalari
        function saveToLocal() {
            localStorage.setItem('localLists', JSON.stringify(lists));
        }

        function loadLocalLists() {
            const saved = localStorage.getItem('localLists');
            lists = saved ? JSON.parse(saved) : [];
            updateStats();
            renderLists();
        }

        function syncLocalToFirebase() {
            const localData = localStorage.getItem('localLists');
            if (localData && currentUser) {
                const localLists = JSON.parse(localData);
                if (localLists.length > 0) {
                    if (confirm('Sizda offline ma\'lumotlar bor. Ularni bulutga yuklashni xohlaysizmi?')) {
                        localLists.forEach(list => {
                            database.ref(`users/${currentUser.uid}/lists`).push({
                                ...list,
                                owner: currentUser.uid,
                                ownerName: currentUser.displayName,
                                createdAt: Date.now()
                            });
                        });
                        localStorage.removeItem('localLists');
                    }
                }
            }
        }

        function loadLists() {
            if (!currentUser) return;

            database.ref(`users/${currentUser.uid}/lists`).on('value', snapshot => {
                const privateLists = [];
                const data = snapshot.val();
                if (data) {
                    Object.keys(data).forEach(key => {
                        privateLists.push({ ...data[key], id: key, isShared: false });
                    });
                }
                
                database.ref('sharedLists').once('value', sharedSnapshot => {
                    const sharedLists = [];
                    const sharedData = sharedSnapshot.val();
                    if (sharedData) {
                        Object.keys(sharedData).forEach(key => {
                            const list = sharedData[key];
                            if (list.owner === currentUser.uid || 
                                (list.sharedWith && list.sharedWith[currentUser.email])) {
                                sharedLists.push({ ...list, id: key, isShared: true });
                            }
                        });
                    }
                    
                    lists = [...privateLists, ...sharedLists];
                    updateStats();
                    renderLists();
                });
            });
        }

        function updateStats() {
            let total = 0;
            let completed = 0;

            lists.forEach(list => {
                if (list.tasks) {
                    total += list.tasks.length;
                    completed += list.tasks.filter(t => t.completed).length;
                }
            });

            const pending = total - completed;
            const rate = total > 0 ? Math.round((completed / total) * 100) : 0;

            document.getElementById('totalTasks').textContent = total;
            document.getElementById('completedTasks').textContent = completed;
            document.getElementById('pendingTasks').textContent = pending;
            document.getElementById('completionRate').textContent = rate + '%';
        }

        function renderLists() {
            const container = document.getElementById('listsContainer');
            const noLists = document.getElementById('noLists');

            let filteredLists = lists;
            
            if (searchQuery) {
                filteredLists = lists.filter(list => {
                    const titleMatch = list.title.toLowerCase().includes(searchQuery);
                    const taskMatch = list.tasks && list.tasks.some(task => 
                        task.text.toLowerCase().includes(searchQuery)
                    );
                    return titleMatch || taskMatch;
                });
            }

            if (filteredLists.length === 0) {
                container.innerHTML = '';
                noLists.style.display = 'block';
                return;
            }

            noLists.style.display = 'none';
            container.innerHTML = '';

            filteredLists.forEach(list => {
                const card = createListCard(list);
                container.appendChild(card);
            });
        }

        function createListCard(list) {
            const card = document.createElement('div');
            card.className = `list-card ${list.isShared ? 'shared' : ''}`;

            const permission = getPermission(list);
            const canEdit = permission === 'creator' || !isOnlineMode;
            const canCheck = permission !== 'viewer' || !isOnlineMode;

            const sortedTasks = (list.tasks || []).sort((a, b) => {
                if (a.starred !== b.starred) return a.starred ? -1 : 1;
                if (a.completed === b.completed) return 0;
                return a.completed ? 1 : -1;
            });

            card.innerHTML = `
                <div class="list-header">
                    <input type="text" class="list-title-edit" value="${list.title}" 
                        ${canEdit ? '' : 'readonly'} 
                        onblur="updateListTitle('${list.id}', this.value, ${list.isShared})">
                    ${canEdit ? `<button class="delete-list-btn" onclick="deleteList('${list.id}', ${list.isShared})">üóëÔ∏è</button>` : ''}
                </div>
                
                ${canEdit ? `
                <div class="task-input-section">
                    <div class="task-input-row">
                        <input type="text" class="task-input" id="taskInput${list.id}" placeholder="Yangi vazifa...">
                        <input type="date" class="deadline-input" id="deadlineInput${list.id}">
                    </div>
                    <button class="add-task-btn" onclick="addTask('${list.id}', ${list.isShared})">+ Qo'shish</button>
                </div>` : ''}
                
                <ul class="tasks-list" id="tasksList${list.id}"></ul>
                
                ${canEdit && list.isShared && isOnlineMode ? `
                <div class="share-section">
                    <strong>üë• Ulashish:</strong>
                    <div class="share-input-group">
                        <input type="email" class="share-email-input" id="shareEmail${list.id}" placeholder="Email">
                        <select class="permission-select" id="sharePerm${list.id}">
                            <option value="viewer">Kuzatuvchi</option>
                            <option value="executor">Bajaruvchi</option>
                            <option value="creator">Yaratuvchi</option>
                        </select>
                        <button class="share-btn" onclick="shareList('${list.id}')">Ulashish</button>
                    </div>
                    <div class="shared-users" id="sharedUsers${list.id}"></div>
                </div>` : ''}
            `;

            const tasksList = card.querySelector(`#tasksList${list.id}`);
            sortedTasks.forEach((task, index) => {
                if (!searchQuery || task.text.toLowerCase().includes(searchQuery)) {
                    const taskItem = createTaskItem(task, index, list.id, list.isShared, canCheck, canEdit);
                    tasksList.appendChild(taskItem);
                }
            });

            if (list.isShared && list.sharedWith) {
                setTimeout(() => renderSharedUsers(list), 0);
            }

            return card;
        }

        function createTaskItem(task, index, listId, isShared, canCheck, canEdit) {
            const li = document.createElement('li');
            li.className = `task-item ${task.completed ? 'completed' : ''} priority-${task.priority || 'medium'}`;

            const now = new Date();
            const deadline = task.deadline ? new Date(task.deadline) : null;
            const isOverdue = deadline && deadline < now && !task.completed;

            li.innerHTML = `
                <div class="task-header">
                    ${canEdit ? `<span class="star-btn ${task.starred ? 'starred' : ''}" onclick="toggleStar('${listId}', ${index}, ${isShared})">‚≠ê</span>` : ''}
                    <div class="checkbox" ${canCheck ? `onclick="toggleTask('${listId}', ${index}, ${isShared})"` : ''}></div>
                    <div class="task-content">
                        <input type="text" class="task-text-edit" value="${task.text}" 
                            ${canEdit ? '' : 'readonly'}
                            onblur="updateTaskText('${listId}', ${index}, this.value, ${isShared})">
                        <div class="task-meta">
                            ${task.deadline ? `<span class="task-deadline ${isOverdue ? 'overdue' : ''}">üìÖ ${formatDate(task.deadline)} ${isOverdue ? '‚ö†Ô∏è' : ''}</span>` : ''}
                            ${task.fileName ? `<a href="${task.fileUrl}" class="task-file" target="_blank" download="${task.fileName}">üìé ${task.fileName}</a>` : ''}
                        </div>
                    </div>
                </div>
                <div class="task-actions">
                    ${canEdit ? `
                    <select class="priority-select priority-${task.priority || 'medium'}" 
                        onchange="updateTaskPriority('${listId}', ${index}, this.value, ${isShared})">
                        <option value="low" ${task.priority === 'low' ? 'selected' : ''}>Past</option>
                        <option value="medium" ${!task.priority || task.priority === 'medium' ? 'selected' : ''}>O'rta</option>
                        <option value="high" ${task.priority === 'high' ? 'selected' : ''}>Yuqori</option>
                        <option value="critical" ${task.priority === 'critical' ? 'selected' : ''}>Kritik</option>
                    </select>
                    ` : ''}
                    <select class="status-select status-${task.status || 'todo'}" 
                        ${canEdit ? '' : 'disabled'}
                        onchange="updateTaskStatus('${listId}', ${index}, this.value, ${isShared})">
                        <option value="backlog" ${task.status === 'backlog' ? 'selected' : ''}>Backlog</option>
                        <option value="todo" ${!task.status || task.status === 'todo' ? 'selected' : ''}>To Do</option>
                        <option value="progress" ${task.status === 'progress' ? 'selected' : ''}>In Progress</option>
                        <option value="review" ${task.status === 'review' ? 'selected' : ''}>Review</option>
                        <option value="done" ${task.status === 'done' ? 'selected' : ''}>Done</option>
                    </select>
                    ${canEdit ? `
                    <label class="file-input-label">
                        üìé Fayl
                        <input type="file" class="file-input" onchange="uploadFile('${listId}', ${index}, this, ${isShared})">
                    </label>
                    <button class="delete-task-btn" onclick="deleteTask('${listId}', ${index}, ${isShared})">üóëÔ∏è</button>
                    ` : ''}
                </div>
            `;

            return li;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const taskDate = new Date(date);
            taskDate.setHours(0, 0, 0, 0);

            const diff = (taskDate - today) / (1000 * 60 * 60 * 24);

            if (diff === 0) return 'Bugun';
            if (diff === 1) return 'Ertaga';
            if (diff === -1) return 'Kecha';
            
            return date.toLocaleDateString('uz-UZ', { day: 'numeric', month: 'short' });
        }

        function getPermission(list) {
            if (!isOnlineMode) return 'creator';
            if (!currentUser) return 'viewer';
            if (list.owner === currentUser.uid) return 'creator';
            if (list.sharedWith && list.sharedWith[currentUser.email]) {
                return list.sharedWith[currentUser.email];
            }
            return 'viewer';
        }

        function saveData(listId, isShared) {
            if (isOnlineMode) {
                const list = lists.find(l => l.id === listId);
                const path = isShared ? `sharedLists/${listId}` : `users/${currentUser.uid}/lists/${listId}`;
                database.ref(path).set(list);
            } else {
                saveToLocal();
            }
            updateStats();
        }

        function updateListTitle(listId, newTitle, isShared) {
            if (!newTitle.trim()) return;
            
            const list = lists.find(l => l.id === listId);
            list.title = newTitle.trim();
            
            if (isOnlineMode) {
                const path = isShared ? `sharedLists/${listId}/title` : `users/${currentUser.uid}/lists/${listId}/title`;
                database.ref(path).set(newTitle.trim());
            } else {
                saveToLocal();
            }
        }

        function deleteList(listId, isShared) {
            if (!confirm('Rostdan ham bu ro\'yxatni o\'chirmoqchimisiz?')) return;
            
            if (isOnlineMode) {
                const path = isShared ? `sharedLists/${listId}` : `users/${currentUser.uid}/lists/${listId}`;
                database.ref(path).remove();
            } else {
                lists = lists.filter(l => l.id !== listId);
                saveToLocal();
                renderLists();
            }
        }

        function createList() {
            const input = document.getElementById('newListInput');
            const title = input.value.trim();

            if (!title) return;

            const newList = {
                id: 'list_' + Date.now(),
                title,
                tasks: [],
                createdAt: Date.now()
            };

            if (isOnlineMode) {
                newList.owner = currentUser.uid;
                newList.ownerName = currentUser.displayName;
                database.ref(`users/${currentUser.uid}/lists`).push(newList);
            } else {
                lists.push(newList);
                saveToLocal();
                renderLists();
            }

            input.value = '';
        }

        function addTask(listId, isShared) {
            const input = document.getElementById(`taskInput${listId}`);
            const deadlineInput = document.getElementById(`deadlineInput${listId}`);
            const text = input.value.trim();
            if (!text) return;

            const list = lists.find(l => l.id === listId);
            if (!list.tasks) list.tasks = [];
            
            const newTask = {
                text,
                completed: false,
                status: 'todo',
                priority: 'medium',
                starred: false,
                createdAt: Date.now()
            };

            if (isOnlineMode) {
                newTask.createdBy = currentUser.uid;
            }

            if (deadlineInput.value) {
                newTask.deadline = deadlineInput.value;
            }

            list.tasks.push(newTask);
            saveData(listId, isShared);
            
            input.value = '';
            deadlineInput.value = '';
            renderLists();
        }

        function updateTaskText(listId, index, newText, isShared) {
            if (!newText.trim()) return;
            
            const list = lists.find(l => l.id === listId);
            list.tasks[index].text = newText.trim();
            saveData(listId, isShared);
        }

        function toggleTask(listId, index, isShared) {
            const list = lists.find(l => l.id === listId);
            list.tasks[index].completed = !list.tasks[index].completed;
            saveData(listId, isShared);
            renderLists();
        }

        function toggleStar(listId, index, isShared) {
            const list = lists.find(l => l.id === listId);
            list.tasks[index].starred = !list.tasks[index].starred;
            saveData(listId, isShared);
            renderLists();
        }

        function updateTaskStatus(listId, index, status, isShared) {
            const list = lists.find(l => l.id === listId);
            list.tasks[index].status = status;
            saveData(listId, isShared);
        }

        function updateTaskPriority(listId, index, priority, isShared) {
            const list = lists.find(l => l.id === listId);
            list.tasks[index].priority = priority;
            saveData(listId, isShared);
            renderLists();
        }

        function uploadFile(listId, index, input, isShared) {
            const file = input.files[0];
            if (!file) return;

            if (file.size > 10 * 1024 * 1024) {
                alert('Fayl hajmi 10MB dan kichik bo\'lishi kerak!');
                return;
            }

            const list = lists.find(l => l.id === listId);
            
            if (isOnlineMode) {
                const storageRef = storage.ref(`files/${currentUser.uid}/${Date.now()}_${file.name}`);
                storageRef.put(file).then(snapshot => {
                    snapshot.ref.getDownloadURL().then(url => {
                        list.tasks[index].fileUrl = url;
                        list.tasks[index].fileName = file.name;
                        saveData(listId, isShared);
                        renderLists();
                    });
                });
            } else {
                // Offline mode - base64
                const reader = new FileReader();
                reader.onload = function(e) {
                    list.tasks[index].fileUrl = e.target.result;
                    list.tasks[index].fileName = file.name;
                    saveToLocal();
                    renderLists();
                };
                reader.readAsDataURL(file);
            }
        }

        function deleteTask(listId, index, isShared) {
            if (!confirm('Bu vazifani o\'chirmoqchimisiz?')) return;
            
            const list = lists.find(l => l.id === listId);
            list.tasks.splice(index, 1);
            saveData(listId, isShared);
            renderLists();
        }

        function shareList(listId) {
            const email = document.getElementById(`shareEmail${listId}`).value.trim();
            const permission = document.getElementById(`sharePerm${listId}`).value;

            if (!email) return;

            database.ref(`sharedLists/${listId}/sharedWith/${email.replace(/\./g, '_')}`).set(permission);
            document.getElementById(`shareEmail${listId}`).value = '';
        }

        function renderSharedUsers(list) {
            const container = document.getElementById(`sharedUsers${list.id}`);
            if (!container || !list.sharedWith) return;

            container.innerHTML = '';
            Object.keys(list.sharedWith).forEach(email => {
                const perm = list.sharedWith[email];
                const div = document.createElement('div');
                div.className = 'shared-user-item';
                div.innerHTML = `
                    <span>${email.replace(/_/g, '.')}</span>
                    <span class="permission-badge perm-${perm}">
                        ${perm === 'viewer' ? 'Kuzatuvchi' : perm === 'executor' ? 'Bajaruvchi' : 'Yaratuvchi'}
                    </span>
                `;
                container.appendChild(div);
            });
        }

        document.getElementById('newListBtn').addEventListener('click', createList);
        document.getElementById('newListInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') createList();
        });
    </script>
</body>
</html>
