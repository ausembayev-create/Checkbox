<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vazifalar Boshqaruvi</title>
    <style>
        :root {
            --primary: #667eea;
            --primary-dark: #5568d3;
            --secondary: #764ba2;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --bg-main: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-card: #ffffff;
            --text-main: #333;
            --text-secondary: #6c757d;
            --border: #e0e0e0;
        }

        [data-theme="dark"] {
            --bg-main: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --bg-card: #0f3460;
            --text-main: #e0e0e0;
            --text-secondary: #a0a0a0;
            --border: #2d3748;
        }

        [data-theme="custom"] {
            --primary: #ff6b6b;
            --primary-dark: #ee5a6f;
            --bg-main: linear-gradient(135deg, #667eea 0%, #f093fb 100%);
            --bg-card: #fff5f7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-main);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-main);
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: var(--bg-card);
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .user-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-name {
            font-size: 18px;
            font-weight: 600;
        }

        .login-btn, .logout-btn {
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .login-btn:hover, .logout-btn:hover {
            background: var(--primary-dark);
        }

        .theme-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .theme-btn {
            padding: 8px 16px;
            border: 2px solid var(--border);
            background: var(--bg-card);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .theme-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .header h1 {
            color: var(--primary);
            font-size: 32px;
            margin-bottom: 15px;
        }

        .new-list-section {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .new-list-input {
            flex: 1;
            min-width: 200px;
            padding: 12px 15px;
            font-size: 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            outline: none;
            background: var(--bg-card);
            color: var(--text-main);
        }

        .share-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: rgba(0,0,0,0.05);
            border-radius: 8px;
            cursor: pointer;
        }

        .new-list-btn {
            padding: 12px 25px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .lists-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
        }

        .list-card {
            background: var(--bg-card);
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            padding: 25px;
            position: relative;
        }

        .list-card.shared {
            border: 2px solid var(--success);
        }

        .list-title-edit {
            font-size: 22px;
            font-weight: bold;
            border: none;
            background: transparent;
            width: 100%;
            padding: 5px;
            margin-bottom: 10px;
            color: var(--text-main);
        }

        .list-title-edit:focus {
            outline: 2px solid var(--primary);
            border-radius: 4px;
        }

        .task-input-section {
            display: flex;
            gap: 8px;
            margin: 15px 0;
        }

        .task-input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background: var(--bg-card);
            color: var(--text-main);
        }

        .add-task-btn {
            padding: 10px 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .tasks-list {
            list-style: none;
            max-height: 500px;
            overflow-y: auto;
        }

        .task-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(0,0,0,0.03);
            border-radius: 6px;
            cursor: pointer;
            gap: 10px;
        }

        .task-item.completed {
            opacity: 0.6;
        }

        .checkbox {
            width: 18px;
            height: 18px;
            min-width: 18px;
            border: 2px solid var(--primary);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .task-item.completed .checkbox {
            background: var(--primary);
        }

        .task-item.completed .checkbox::after {
            content: '‚úì';
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .task-text {
            flex: 1;
            font-size: 15px;
        }

        .task-item.completed .task-text {
            text-decoration: line-through;
            color: var(--text-secondary);
        }

        .status-select {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            cursor: pointer;
        }

        .status-backlog { background: #6c757d; color: white; }
        .status-todo { background: #007bff; color: white; }
        .status-progress { background: #ffc107; color: black; }
        .status-review { background: #17a2b8; color: white; }
        .status-done { background: #28a745; color: white; }
        .status-hold { background: #dc3545; color: white; }

        .delete-task-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .share-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid var(--border);
        }

        .share-input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .share-email-input {
            flex: 1;
            padding: 8px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background: var(--bg-card);
            color: var(--text-main);
        }

        .permission-select {
            padding: 8px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background: var(--bg-card);
            color: var(--text-main);
        }

        .share-btn {
            padding: 8px 16px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .shared-users {
            margin-top: 10px;
        }

        .shared-user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: rgba(0,0,0,0.03);
            border-radius: 4px;
            margin-bottom: 5px;
            font-size: 13px;
        }

        .permission-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .perm-viewer { background: #17a2b8; color: white; }
        .perm-executor { background: #ffc107; color: black; }
        .perm-creator { background: #28a745; color: white; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
        }

        .status-tooltip {
            position: absolute;
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 100;
            display: none;
            max-width: 200px;
        }

        .no-lists {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-main);
            font-size: 18px;
        }

        @media (max-width: 768px) {
            .lists-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body data-theme="light">
    <div class="main-container">
        <div class="header">
            <div class="user-section">
                <div class="user-info" id="userInfo">
                    <button class="login-btn" id="loginBtn">Google orqali kirish</button>
                </div>
                <div class="theme-selector">
                    <span style="font-size: 13px; margin-right: 5px;">Tema:</span>
                    <button class="theme-btn active" data-theme="light">‚òÄÔ∏è Kungi</button>
                    <button class="theme-btn" data-theme="dark">üåô Tungi</button>
                    <button class="theme-btn" data-theme="custom">üé® Maxsus</button>
                </div>
            </div>

            <h1>üìã Vazifalar Boshqaruvi</h1>
            
            <div class="new-list-section">
                <input type="text" id="newListInput" class="new-list-input" placeholder="Yangi ro'yxat nomi">
                <div class="share-toggle">
                    <input type="checkbox" id="shareCheckbox">
                    <label for="shareCheckbox">üåê Umumiy</label>
                </div>
                <button id="newListBtn" class="new-list-btn">+ Yaratish</button>
            </div>
        </div>

        <div id="listsContainer" class="lists-container"></div>
        <div id="noLists" class="no-lists" style="display: none;">
            <div style="font-size: 60px; margin-bottom: 20px;">üìù</div>
            <p>Hozircha ro'yxatlar yo'q. Yuqorida yangi ro'yxat yarating!</p>
        </div>
    </div>

    <div class="status-tooltip" id="statusTooltip"></div>

    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-database-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-auth-compat.min.js"></script>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCwtHihzq8qFRCaCsZtJBC16cPG-DUWho0",
            authDomain: "checkbox-5b848.firebaseapp.com",
            databaseURL: "https://checkbox-5b848-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "checkbox-5b848",
            storageBucket: "checkbox-5b848.firebasestorage.app",
            messagingSenderId: "461550771942",
            appId: "1:461550771942:web:53def1224b2f8ded95e527"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();

        let currentUser = null;
        let lists = [];

        const statusDescriptions = {
            'backlog': 'Rejalashtirilgan: Kelajakda bajarilishi kerak bo\'lgan vazifalar',
            'todo': 'Bajarish kerak: Tez orada boshlanishi kerak',
            'progress': 'Jarayonda: Hozir ustida ishlanmoqda',
            'review': 'Tekshiruv: Yakunlangan, lekin tekshirish kerak',
            'done': 'Bajarildi: To\'liq yakunlangan',
            'hold': 'To\'xtatilgan: Vaqtincha to\'xtatilgan yoki arxivlangan'
        };

        // Tema o'zgartirish
        document.querySelectorAll('.theme-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const theme = btn.dataset.theme;
                document.body.setAttribute('data-theme', theme);
                document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                localStorage.setItem('theme', theme);
            });
        });

        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.body.setAttribute('data-theme', savedTheme);
            document.querySelector(`[data-theme="${savedTheme}"]`).classList.add('active');
            document.querySelector('[data-theme="light"]').classList.remove('active');
        }

        // Google Authentication
        document.getElementById('loginBtn').addEventListener('click', () => {
            auth.signInWithPopup(provider).catch(err => {
                console.error('Login error:', err);
                alert('Kirishda xatolik yuz berdi!');
            });
        });

        auth.onAuthStateChanged(user => {
            currentUser = user;
            updateUserUI();
            if (user) {
                loadLists();
            }
        });

        function updateUserUI() {
            const userInfo = document.getElementById('userInfo');
            if (currentUser) {
                userInfo.innerHTML = `
                    <img src="${currentUser.photoURL}" class="user-avatar" alt="Avatar">
                    <div>
                        <div class="user-name">${currentUser.displayName}</div>
                        <div style="font-size: 12px; color: var(--text-secondary)">${currentUser.email}</div>
                    </div>
                    <button class="logout-btn" onclick="logout()">Chiqish</button>
                `;
            }
        }

        function logout() {
            auth.signOut();
            lists = [];
            renderLists();
        }

        function loadLists() {
            if (!currentUser) return;

            // Shaxsiy ro'yxatlar
            database.ref(`users/${currentUser.uid}/lists`).on('value', snapshot => {
                const privateLists = [];
                const data = snapshot.val();
                if (data) {
                    Object.keys(data).forEach(key => {
                        privateLists.push({ ...data[key], id: key, isShared: false });
                    });
                }
                
                // Umumiy ro'yxatlar
                database.ref('sharedLists').once('value', sharedSnapshot => {
                    const sharedLists = [];
                    const sharedData = sharedSnapshot.val();
                    if (sharedData) {
                        Object.keys(sharedData).forEach(key => {
                            const list = sharedData[key];
                            if (list.owner === currentUser.uid || 
                                (list.sharedWith && list.sharedWith[currentUser.email])) {
                                sharedLists.push({ ...list, id: key, isShared: true });
                            }
                        });
                    }
                    
                    lists = [...privateLists, ...sharedLists];
                    renderLists();
                });
            });
        }

        function renderLists() {
            const container = document.getElementById('listsContainer');
            const noLists = document.getElementById('noLists');

            if (lists.length === 0) {
                container.innerHTML = '';
                noLists.style.display = 'block';
                return;
            }

            noLists.style.display = 'none';
            container.innerHTML = '';

            lists.forEach(list => {
                const card = createListCard(list);
                container.appendChild(card);
            });
        }

        function createListCard(list) {
            const card = document.createElement('div');
            card.className = `list-card ${list.isShared ? 'shared' : ''}`;

            const permission = getPermission(list);
            const canEdit = permission === 'creator';
            const canCheck = permission !== 'viewer';

            // Vazifalarni sortlash: bajarilmaganlar yuqorida
            const sortedTasks = (list.tasks || []).sort((a, b) => {
                if (a.completed === b.completed) return 0;
                return a.completed ? 1 : -1;
            });

            card.innerHTML = `
                <input type="text" class="list-title-edit" value="${list.title}" 
                    ${canEdit ? '' : 'readonly'} 
                    onblur="updateListTitle('${list.id}', this.value, ${list.isShared})">
                
                ${canEdit ? `
                <div class="task-input-section">
                    <input type="text" class="task-input" id="taskInput${list.id}" placeholder="Yangi vazifa...">
                    <button class="add-task-btn" onclick="addTask('${list.id}', ${list.isShared})">+</button>
                </div>` : ''}
                
                <ul class="tasks-list" id="tasksList${list.id}"></ul>
                
                ${canEdit && list.isShared ? `
                <div class="share-section">
                    <strong>Ulashish:</strong>
                    <div class="share-input-group">
                        <input type="email" class="share-email-input" id="shareEmail${list.id}" placeholder="Email manzil">
                        <select class="permission-select" id="sharePerm${list.id}">
                            <option value="viewer">Kuzatuvchi</option>
                            <option value="executor">Bajaruvchi</option>
                            <option value="creator">Yaratuvchi</option>
                        </select>
                        <button class="share-btn" onclick="shareList('${list.id}')">Ulashish</button>
                    </div>
                    <div class="shared-users" id="sharedUsers${list.id}"></div>
                </div>` : ''}
            `;

            const tasksList = card.querySelector(`#tasksList${list.id}`);
            sortedTasks.forEach((task, index) => {
                const taskItem = createTaskItem(task, index, list.id, list.isShared, canCheck, canEdit);
                tasksList.appendChild(taskItem);
            });

            if (list.isShared && list.sharedWith) {
                setTimeout(() => renderSharedUsers(list), 0);
            }

            return card;
        }

        function createTaskItem(task, index, listId, isShared, canCheck, canEdit) {
            const li = document.createElement('li');
            li.className = `task-item ${task.completed ? 'completed' : ''}`;

            li.innerHTML = `
                <div class="checkbox" ${canCheck ? `onclick="toggleTask('${listId}', ${index}, ${isShared})"` : ''}></div>
                <span class="task-text">${task.text}</span>
                <select class="status-select status-${task.status || 'todo'}" 
                    ${canEdit ? '' : 'disabled'}
                    onchange="updateTaskStatus('${listId}', ${index}, this.value, ${isShared})"
                    onmouseenter="showStatusTooltip(event, '${task.status || 'todo'}')"
                    onmouseleave="hideStatusTooltip()">
                    <option value="backlog" ${task.status === 'backlog' ? 'selected' : ''}>Backlog</option>
                    <option value="todo" ${!task.status || task.status === 'todo' ? 'selected' : ''}>To Do</option>
                    <option value="progress" ${task.status === 'progress' ? 'selected' : ''}>In Progress</option>
                    <option value="review" ${task.status === 'review' ? 'selected' : ''}>Review</option>
                    <option value="done" ${task.status === 'done' ? 'selected' : ''}>Done</option>
                    <option value="hold" ${task.status === 'hold' ? 'selected' : ''}>On Hold</option>
                </select>
                ${canEdit ? `<button class="delete-task-btn" onclick="deleteTask('${listId}', ${index}, ${isShared})">√ó</button>` : ''}
            `;

            return li;
        }

        function getPermission(list) {
            if (!currentUser) return 'viewer';
            if (list.owner === currentUser.uid) return 'creator';
            if (list.sharedWith && list.sharedWith[currentUser.email]) {
                return list.sharedWith[currentUser.email];
            }
            return 'viewer';
        }

        function updateListTitle(listId, newTitle, isShared) {
            if (!newTitle.trim()) return;
            
            const path = isShared ? `sharedLists/${listId}/title` : `users/${currentUser.uid}/lists/${listId}/title`;
            database.ref(path).set(newTitle.trim());
        }

        function createList() {
            if (!currentUser) {
                alert('Iltimos, avval tizimga kiring!');
                return;
            }

            const input = document.getElementById('newListInput');
            const title = input.value.trim();
            const isShared = document.getElementById('shareCheckbox').checked;

            if (!title) return;

            const newList = {
                title,
                tasks: [],
                owner: currentUser.uid,
                ownerName: currentUser.displayName,
                createdAt: Date.now()
            };

            if (isShared) {
                newList.sharedWith = {};
                database.ref('sharedLists').push(newList);
            } else {
                database.ref(`users/${currentUser.uid}/lists`).push(newList);
            }

            input.value = '';
            document.getElementById('shareCheckbox').checked = false;
        }

        function addTask(listId, isShared) {
            const input = document.getElementById(`taskInput${listId}`);
            const text = input.value.trim();
            if (!text) return;

            const list = lists.find(l => l.id === listId);
            const tasks = list.tasks || [];
            tasks.push({
                text,
                completed: false,
                status: 'todo',
                createdBy: currentUser.uid,
                assignedTo: currentUser.uid
            });

            const path = isShared ? `sharedLists/${listId}/tasks` : `users/${currentUser.uid}/lists/${listId}/tasks`;
            database.ref(path).set(tasks);
            input.value = '';
        }

        function toggleTask(listId, index, isShared) {
            const list = lists.find(l => l.id === listId);
            const tasks = list.tasks;
            tasks[index].completed = !tasks[index].completed;

            const path = isShared ? `sharedLists/${listId}/tasks` : `users/${currentUser.uid}/lists/${listId}/tasks`;
            database.ref(path).set(tasks);
        }

        function updateTaskStatus(listId, index, status, isShared) {
            const list = lists.find(l => l.id === listId);
            const tasks = list.tasks;
            tasks[index].status = status;

            const path = isShared ? `sharedLists/${listId}/tasks` : `users/${currentUser.uid}/lists/${listId}/tasks`;
            database.ref(path).set(tasks);
        }

        function deleteTask(listId, index, isShared) {
            const list = lists.find(l => l.id === listId);
            const tasks = list.tasks;
            tasks.splice(index, 1);

            const path = isShared ? `sharedLists/${listId}/tasks` : `users/${currentUser.uid}/lists/${listId}/tasks`;
            database.ref(path).set(tasks);
        }

        function shareList(listId) {
            const email = document.getElementById(`shareEmail${listId}`).value.trim();
            const permission = document.getElementById(`sharePerm${listId}`).value;

            if (!email) return;

            database.ref(`sharedLists/${listId}/sharedWith/${email.replace(/\./g, '_')}`).set(permission);
            document.getElementById(`shareEmail${listId}`).value = '';
        }

        function renderSharedUsers(list) {
            const container = document.getElementById(`sharedUsers${list.id}`);
            if (!container || !list.sharedWith) return;

            container.innerHTML = '';
            Object.keys(list.sharedWith).forEach(email => {
                const perm = list.sharedWith[email];
                const div = document.createElement('div');
                div.className = 'shared-user-item';
                div.innerHTML = `
                    <span>${email.replace(/_/g, '.')}</span>
                    <span class="permission-badge perm-${perm}">
                        ${perm === 'viewer' ? 'Kuzatuvchi' : perm === 'executor' ? 'Bajaruvchi' : 'Yaratuvchi'}
                    </span>
                `;
                container.appendChild(div);
            });
        }

        function showStatusTooltip(event, status) {
            const tooltip = document.getElementById('statusTooltip');
            tooltip.textContent = statusDescriptions[status] || '';
            tooltip.style.display = 'block';
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY + 10 + 'px';
        }

        function hideStatusTooltip() {
            document.getElementById('statusTooltip').style.display = 'none';
        }

        document.getElementById('newListBtn').addEventListener('click', createList);
        document.getElementById('newListInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') createList();
        });
    </script>
</body>
</html>
