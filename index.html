<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CheckBox Task</title>
    <style>
        :root {
            --primary: #667eea;
            --primary-dark: #5568d3;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --bg-main: #f5f5f5;
            --bg-card: #ffffff;
            --text-main: #333;
            --text-secondary: #6c757d;
            --border: #e0e0e0;
        }

        [data-theme="dark"] {
            --bg-main: #1a1a1a;
            --bg-card: #2d2d2d;
            --text-main: #e0e0e0;
            --text-secondary: #a0a0a0;
            --border: #404040;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-main);
            min-height: 100vh;
            padding: 10px;
            color: var(--text-main);
            transition: all 0.3s ease;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .user-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
            flex-wrap: wrap;
            gap: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary);
        }

        .user-name {
            font-size: 16px;
            font-weight: 600;
        }

        .login-btn, .logout-btn {
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .login-btn:hover, .logout-btn:hover {
            background: var(--primary-dark);
        }

        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 8px 15px;
            background: var(--bg-main);
            border-radius: 8px;
        }

        .header h1 {
            color: var(--primary);
            font-size: 28px;
            margin-bottom: 15px;
        }

        .tabs-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 20px;
            background: var(--bg-main);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            color: var(--text-main);
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: var(--bg-main);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .filters-section {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 15px;
            background: var(--bg-main);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
            color: var(--text-main);
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .search-wrapper {
            position: relative;
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px 12px 40px;
            font-size: 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-main);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
        }

        .new-list-section {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .new-list-input {
            flex: 1;
            min-width: 200px;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-main);
        }

        .new-list-btn, .action-btn {
            padding: 12px 25px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .lists-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .list-card {
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        .list-card.shared {
            border: 2px solid var(--success);
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            gap: 10px;
        }

        .list-title-edit {
            font-size: 20px;
            font-weight: bold;
            border: none;
            background: transparent;
            flex: 1;
            padding: 5px;
            color: var(--text-main);
        }

        .list-actions {
            display: flex;
            gap: 5px;
        }

        .icon-btn {
            padding: 6px 10px;
            background: var(--bg-main);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            color: var(--text-main);
        }

        .delete-list-btn {
            background: var(--danger);
            color: white;
        }

        .tags-section {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }

        .tag {
            padding: 4px 10px;
            background: var(--primary);
            color: white;
            border-radius: 12px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .tag-remove {
            cursor: pointer;
            font-weight: bold;
        }

        .task-input-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 12px 0;
        }

        .task-input-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .task-input {
            flex: 1;
            min-width: 150px;
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-main);
        }

        .deadline-input, .recurring-select {
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-main);
            cursor: pointer;
        }

        .add-task-btn {
            padding: 10px 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .tasks-list {
            list-style: none;
            max-height: 600px;
            overflow-y: auto;
        }

        .task-item {
            background: var(--bg-main);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 3px solid transparent;
            cursor: grab;
            position: relative;
        }

        .task-item:active {
            cursor: grabbing;
        }

        .task-item.completed {
            opacity: 0.6;
        }

        .task-item.priority-low { border-left-color: #6c757d; }
        .task-item.priority-medium { border-left-color: #ffc107; }
        .task-item.priority-high { border-left-color: #ff6b35; }
        .task-item.priority-critical { border-left-color: #dc3545; }

        .task-item.recurring::after {
            content: 'üîÑ';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 12px;
        }

        .task-header {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 8px;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            min-width: 20px;
            border: 2px solid var(--primary);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .task-item.completed .checkbox {
            background: var(--primary);
        }

        .task-item.completed .checkbox::after {
            content: '‚úì';
            color: white;
            font-weight: bold;
        }

        .task-content {
            flex: 1;
            min-width: 0;
        }

        .task-text-edit {
            width: 100%;
            font-size: 14px;
            padding: 4px;
            border: none;
            background: transparent;
            color: var(--text-main);
        }

        .task-item.completed .task-text-edit {
            text-decoration: line-through;
            color: var(--text-secondary);
        }

        .task-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
            font-size: 12px;
        }

        .task-deadline {
            color: var(--text-secondary);
        }

        .task-deadline.overdue {
            color: var(--danger);
            font-weight: 600;
        }

        .task-file {
            color: var(--primary);
            text-decoration: none;
        }

        .task-time-spent {
            color: var(--info);
            font-weight: 600;
        }

        .subtasks-section {
            margin-top: 10px;
            padding-left: 30px;
        }

        .subtask-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px;
            margin-bottom: 5px;
            background: var(--bg-card);
            border-radius: 5px;
        }

        .subtask-checkbox {
            width: 16px;
            height: 16px;
            border: 2px solid var(--primary);
            border-radius: 4px;
            cursor: pointer;
        }

        .subtask-item.completed .subtask-checkbox {
            background: var(--primary);
        }

        .subtask-text {
            flex: 1;
            font-size: 13px;
        }

        .subtask-item.completed .subtask-text {
            text-decoration: line-through;
            color: var(--text-secondary);
        }

        .subtask-input-wrapper {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .subtask-input {
            flex: 1;
            padding: 6px;
            border: 1px solid var(--border);
            border-radius: 5px;
            font-size: 12px;
            background: var(--bg-card);
            color: var(--text-main);
        }

        .comments-section {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        .comment-item {
            padding: 8px;
            margin-bottom: 8px;
            background: var(--bg-card);
            border-radius: 5px;
            font-size: 12px;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .comment-author {
            font-weight: 600;
            color: var(--primary);
        }

        .comment-time {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .comment-input-wrapper {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .comment-input {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 5px;
            font-size: 12px;
            background: var(--bg-card);
            color: var(--text-main);
        }

        .comment-btn {
            padding: 8px 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .task-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .priority-select, .status-select {
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 11px;
            border: 1px solid var(--border);
            cursor: pointer;
            font-weight: 600;
        }

        .priority-low { background: #6c757d; color: white; }
        .priority-medium { background: #ffc107; color: black; }
        .priority-high { background: #ff6b35; color: white; }
        .priority-critical { background: #dc3545; color: white; }

        .status-backlog { background: #6c757d; color: white; }
        .status-todo { background: #007bff; color: white; }
        .status-progress { background: #ffc107; color: black; }
        .status-review { background: #17a2b8; color: white; }
        .status-done { background: #28a745; color: white; }

        .file-input-label {
            padding: 4px 10px;
            background: var(--primary);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
        }

        .file-input {
            display: none;
        }

        .timer-btn {
            padding: 4px 10px;
            background: var(--info);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
        }

        .timer-btn.running {
            background: var(--danger);
        }

        .delete-task-btn {
            padding: 4px 10px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
        }

        .share-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid var(--border);
        }

        .share-task-section {
            margin-top: 10px;
            padding: 10px;
            background: var(--bg-main);
            border-radius: 8px;
        }

        .share-task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .permission-info {
            background: var(--bg-main);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 12px;
        }

        .permission-info-item {
            padding: 5px 0;
        }

        .share-input-group {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .share-email-input {
            flex: 1;
            min-width: 150px;
            padding: 8px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background: var(--bg-card);
            color: var(--text-main);
        }

        .permission-select {
            padding: 8px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background: var(--bg-card);
            color: var(--text-main);
        }

        .share-btn {
            padding: 8px 16px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .shared-users {
            margin-top: 10px;
        }

        .shared-user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: var(--bg-main);
            border-radius: 6px;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .permission-badge {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }

        .perm-viewer { background: #6c757d; color: white; }
        .perm-editor { background: #ffc107; color: black; }
        .perm-manager { background: #28a745; color: white; }

        .calendar-container {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            padding: 10px;
            background: var(--bg-main);
            border-radius: 5px;
        }

        .calendar-day {
            min-height: 100px;
            padding: 5px;
            background: var(--bg-main);
            border-radius: 5px;
            cursor: pointer;
        }

        .calendar-day.today {
            background: var(--primary);
            color: white;
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day-number {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .calendar-task-item {
            font-size: 10px;
            padding: 2px 4px;
            background: var(--primary);
            color: white;
            border-radius: 3px;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .templates-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .template-card {
            background: var(--bg-card);
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid var(--border);
        }

        .template-card:hover {
            border-color: var(--primary);
        }

        .template-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .template-description {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .analytics-container {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
        }

        .chart-container {
            margin-bottom: 30px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .notifications-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 350px;
            z-index: 10000;
        }

        .notification-item {
            background: var(--bg-card);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification-item.success {
            border-left: 4px solid var(--success);
        }

        .notification-item.warning {
            border-left: 4px solid var(--warning);
        }

        .notification-item.danger {
            border-left: 4px solid var(--danger);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 600;
        }

        .modal-close {
            font-size: 28px;
            cursor: pointer;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .lists-container {
                grid-template-columns: 1fr;
            }
            .calendar-day {
                min-height: 60px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body data-theme="light">
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="notifications-panel" id="notificationsPanel"></div>

    <div class="main-container">
        <div class="header">
            <div class="user-section">
                <div class="user-info" id="userInfo">
                    <button class="login-btn" id="loginBtn">Google orqali kirish</button>
                </div>
                <div class="theme-toggle" onclick="toggleTheme()">
                    <span id="themeIcon">üåô</span>
                    <span id="themeText">Qorong'i rejim</span>
                </div>
            </div>

            <h1>‚òëÔ∏è CheckBox Task</h1>

            <div class="tabs-nav">
                <button class="tab-btn active" onclick="switchTab('lists')">üìã Ro'yxatlar</button>
                <button class="tab-btn" onclick="switchTab('calendar')">üìÖ Kalendar</button>
                <button class="tab-btn" onclick="switchTab('analytics')">üìä Statistika</button>
                <button class="tab-btn" onclick="switchTab('templates')">üìë Shablonlar</button>
            </div>

            <div id="listsTab" class="tab-content active">
                <div class="stats-bar">
                    <div class="stat-card">
                        <div class="stat-number" id="totalTasks">0</div>
                        <div class="stat-label">Jami</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="completedTasks">0</div>
                        <div class="stat-label">Bajarilgan</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="pendingTasks">0</div>
                        <div class="stat-label">Kutilmoqda</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="overdueTasks">0</div>
                        <div class="stat-label">Muddati o'tgan</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="completionRate">0%</div>
                        <div class="stat-label">Foiz</div>
                    </div>
                </div>

                <div class="filters-section">
                    <button class="filter-btn active" onclick="applyFilter('all')">Barchasi</button>
                    <button class="filter-btn" onclick="applyFilter('high-priority')">üî¥ Yuqori prioritet</button>
                    <button class="filter-btn" onclick="applyFilter('overdue')">‚ö†Ô∏è Muddati o'tgan</button>
                    <button class="filter-btn" onclick="applyFilter('today')">üìÖ Bugun</button>
                </div>

                <div class="search-wrapper">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="searchInput" class="search-input" placeholder="Vazifalarni qidirish...">
                </div>
                
                <div class="new-list-section">
                    <input type="text" id="newListInput" class="new-list-input" placeholder="Yangi ro'yxat nomi...">
                    <button id="newListBtn" class="new-list-btn">+ Yaratish</button>
                    <button class="action-btn" onclick="openImportModal()">üì• Import</button>
                    <button class="action-btn" onclick="exportAllData()">üì§ Export</button>
                </div>
            </div>

            <div id="calendarTab" class="tab-content">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <h2 id="calendarMonth"></h2>
                        <div class="calendar-nav">
                            <button class="action-btn" onclick="previousMonth()">‚óÄ Oldingi</button>
                            <button class="action-btn" onclick="currentMonth()">Bugun</button>
                            <button class="action-btn" onclick="nextMonth()">Keyingi ‚ñ∂</button>
                        </div>
                    </div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>
            </div>

            <div id="analyticsTab" class="tab-content">
                <div class="analytics-container">
                    <div class="chart-container">
                        <div class="chart-title">Kunlik faollik</div>
                        <canvas id="activityChart" width="400" height="200"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Prioritet bo'yicha taqsimot</div>
                        <canvas id="priorityChart" width="400" height="200"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Bajarilish statistikasi</div>
                        <div id="completionStats"></div>
                    </div>
                </div>
            </div>

            <div id="templatesTab" class="tab-content">
                <div class="templates-container" id="templatesContainer"></div>
            </div>
        </div>

        <div id="listsContainer" class="lists-container"></div>
    </div>

    <div class="modal" id="importModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Ma'lumotlarni import qilish</div>
                <span class="modal-close" onclick="closeModal('importModal')">&times;</span>
            </div>
            <div class="modal-body">
                <input type="file" id="importFile" accept=".json">
                <p style="font-size: 13px; color: var(--text-secondary); margin-top: 10px;">
                    JSON formatdagi faylni tanlang
                </p>
            </div>
            <div class="modal-footer">
                <button class="action-btn" onclick="closeModal('importModal')" style="background: var(--text-secondary);">Bekor qilish</button>
                <button class="action-btn" onclick="importData()">Import qilish</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-database-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-storage-compat.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCwtHihZq8qFRCaCs2tJBC16cPG-bUWho0",
            authDomain: "checkbox-5b848.firebaseapp.com",
            databaseURL: "https://checkbox-5b848-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "checkbox-5b848",
            storageBucket: "checkbox-5b848.firebasestorage.app",
            messagingSenderId: "461550771942",
            appId: "1:461550771942:web:53def1224b2f8ded95e527"
        };

        let database, auth, storage, provider;
        
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            auth = firebase.auth();
            storage = firebase.storage();
            provider = new firebase.auth.GoogleAuthProvider();
        } catch (error) {
            console.error('Firebase init error:', error);
        }

        let currentUser = null;
        let lists = [];
        let searchQuery = '';
        let currentFilter = 'all';
        let isOnlineMode = false;
        let timers = {};
        let currentCalendarDate = new Date();
        let activityChart = null;
        let priorityChart = null;

        const templates = [
            {
                title: "Kundalik ish rejalari",
                description: "Har kuni bajaradigan vazifalar",
                tasks: [
                    { text: "Email tekshirish", priority: "medium", status: "todo" },
                    { text: "Kun rejasini tuzish", priority: "high", status: "todo" },
                    { text: "Uchrashuvlar", priority: "medium", status: "todo" }
                ]
            },
            {
                title: "Loyiha boshqaruvi",
                description: "Loyiha uchun standart vazifalar",
                tasks: [
                    { text: "Talablarni yig'ish", priority: "high", status: "backlog" },
                    { text: "Dizayn yaratish", priority: "high", status: "backlog" },
                    { text: "Dasturlash", priority: "critical", status: "backlog" },
                    { text: "Testing", priority: "high", status: "backlog" },
                    { text: "Deploy", priority: "medium", status: "backlog" }
                ]
            },
            {
                title: "Xaridlar ro'yxati",
                description: "Do'kon uchun kerakli narsalar",
                tasks: [
                    { text: "Non", priority: "low", status: "todo" },
                    { text: "Sut", priority: "low", status: "todo" },
                    { text: "Meva va sabzavotlar", priority: "medium", status: "todo" }
                ]
            }
        ];

        function showLoading(show = true) {
            document.getElementById('loadingOverlay').classList.toggle('active', show);
        }

        function showNotification(message, type = 'success', duration = 3000) {
            const panel = document.getElementById('notificationsPanel');
            const notification = document.createElement('div');
            notification.className = `notification-item ${type}`;
            notification.innerHTML = `<div style="font-weight: 600;">${message}</div>`;
            panel.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, duration);
        }

        function showError(msg) { showNotification(msg, 'danger', 5000); }
        function showSuccess(msg) { showNotification(msg, 'success', 3000); }

        function validateEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function sanitizeInput(input) {
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }

        function toggleTheme() {
            const current = document.body.getAttribute('data-theme');
            const newTheme = current === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', newTheme);
            document.getElementById('themeIcon').textContent = newTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            document.getElementById('themeText').textContent = newTheme === 'light' ? 'Qorong\'i rejim' : 'Yorug\' rejim';
            localStorage.setItem('theme', newTheme);
        }

        try {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') toggleTheme();
        } catch (e) {}

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'calendar') renderCalendar();
            else if (tabName === 'analytics') renderAnalytics();
            else if (tabName === 'templates') renderTemplates();
        }

        document.getElementById('searchInput').addEventListener('input', (e) => {
            searchQuery = e.target.value.toLowerCase();
            renderLists();
        });

        function applyFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderLists();
        }

        function filterTasks(tasks) {
            if (!tasks) return [];
            
            let filtered = tasks;
            
            if (searchQuery) {
                filtered = filtered.filter(task => 
                    task.text.toLowerCase().includes(searchQuery) ||
                    (task.tags && task.tags.some(tag => tag.toLowerCase().includes(searchQuery)))
                );
            }
            
            const now = new Date();
            switch (currentFilter) {
                case 'high-priority':
                    filtered = filtered.filter(t => t.priority === 'high' || t.priority === 'critical');
                    break;
                case 'overdue':
                    filtered = filtered.filter(t => {
                        if (!t.deadline || t.completed) return false;
                        return new Date(t.deadline) < now;
                    });
                    break;
                case 'today':
                    filtered = filtered.filter(t => {
                        if (!t.deadline) return false;
                        return new Date(t.deadline).toDateString() === now.toDateString();
                    });
                    break;
            }
            
            return filtered;
        }

        document.getElementById('loginBtn').addEventListener('click', async () => {
            const btn = document.getElementById('loginBtn');
            btn.disabled = true;
            btn.textContent = 'Yuklanmoqda...';
            showLoading(true);
            
            try {
                await auth.signInWithPopup(provider);
                showSuccess('Muvaffaqiyatli kirdingiz!');
            } catch (error) {
                showError('Kirishda xatolik: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Google orqali kirish';
                showLoading(false);
            }
        });

        auth.onAuthStateChanged(user => {
            currentUser = user;
            updateUserUI();
            
            if (user) {
                isOnlineMode = true;
                syncLocalToFirebase();
                loadLists();
                checkDeadlines();
            } else {
                isOnlineMode = false;
                loadLocalLists();
            }
        });

        function updateUserUI() {
            const userInfo = document.getElementById('userInfo');
            if (currentUser) {
                userInfo.innerHTML = `
                    <img src="${currentUser.photoURL}" class="user-avatar" alt="Avatar">
                    <div>
                        <div class="user-name">${sanitizeInput(currentUser.displayName)}</div>
                        <div style="font-size: 11px; color: var(--text-secondary)">${sanitizeInput(currentUser.email)}</div>
                    </div>
                    <button class="logout-btn" onclick="logout()">Chiqish</button>
                `;
            }
        }

        function logout() {
            if (confirm('Chiqishni xohlaysizmi?')) {
                auth.signOut();
            }
        }

        function checkDeadlines() {
            if (!lists.length) return;
            
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            lists.forEach(list => {
                if (!list.tasks) return;
                
                list.tasks.forEach(task => {
                    if (task.completed || !task.deadline) return;
                    
                    const deadline = new Date(task.deadline);
                    
                    if (deadline < now) {
                        showNotification(`‚ö†Ô∏è Muddati o'tgan: ${task.text}`, 'danger', 5000);
                    } else if (deadline.toDateString() === tomorrow.toDateString()) {
                        showNotification(`üìÖ Ertaga: ${task.text}`, 'warning', 5000);
                    } else if (deadline.toDateString() === now.toDateString()) {
                        showNotification(`üîî Bugun: ${task.text}`, 'warning', 5000);
                    }
                });
            });
        }

        setInterval(checkDeadlines, 3600000);

        function saveToLocal() {
            try {
                localStorage.setItem('localLists', JSON.stringify(lists));
            } catch (error) {
                showError('Xotirada saqlashda xatolik');
            }
        }

        function loadLocalLists() {
            try {
                const saved = localStorage.getItem('localLists');
                lists = saved ? JSON.parse(saved) : [];
                updateStats();
                renderLists();
            } catch (error) {
                lists = [];
            }
        }

        async function syncLocalToFirebase() {
            try {
                const localData = localStorage.getItem('localLists');
                if (localData && currentUser) {
                    const localLists = JSON.parse(localData);
                    if (localLists.length > 0) {
                        if (confirm(`Sizda ${localLists.length} ta offline ro'yxat bor. Ularni bulutga yuklashni xohlaysizmi?`)) {
                            showLoading(true);
                            
                            for (const list of localLists) {
                                await database.ref(`users/${currentUser.uid}/lists`).push({
                                    ...list,
                                    owner: currentUser.uid,
                                    ownerName: currentUser.displayName
                                });
                            }
                            
                            localStorage.removeItem('localLists');
                            showSuccess('Ma\'lumotlar bulutga yuklandi!');
                        }
                    }
                }
            } catch (error) {
                showError('Sinxronizatsiyada xatolik');
            } finally {
                showLoading(false);
            }
        }

        function loadLists() {
            if (!currentUser) return;

            database.ref(`users/${currentUser.uid}/lists`).on('value', snapshot => {
                const privateLists = [];
                const data = snapshot.val();
                
                if (data) {
                    Object.keys(data).forEach(key => {
                        privateLists.push({ ...data[key], id: key, isShared: false });
                    });
                }
                
                database.ref('sharedLists').once('value', sharedSnapshot => {
                    const sharedLists = [];
                    const sharedData = sharedSnapshot.val();
                    
                    if (sharedData) {
                        Object.keys(sharedData).forEach(key => {
                            const list = sharedData[key];
                            if (list.owner === currentUser.uid || 
                                (list.sharedWith && list.sharedWith[currentUser.email.replace(/\./g, '_')])) {
                                sharedLists.push({ ...list, id: key, isShared: true });
                            }
                        });
                    }
                    
                    // Load shared tasks
                    database.ref('sharedTasks').once('value', sharedTasksSnapshot => {
                        const sharedTasksData = sharedTasksSnapshot.val();
                        
                        lists = [...privateLists, ...sharedLists];
                        
                        // Add shared tasks to lists
                        if (sharedTasksData) {
                            Object.keys(sharedTasksData).forEach(taskKey => {
                                const sharedTask = sharedTasksData[taskKey];
                                if (sharedTask.sharedWith && sharedTask.sharedWith[currentUser.email.replace(/\./g, '_')]) {
                                    // Find the list and add the task
                                    const list = lists.find(l => l.id === sharedTask.listId);
                                    if (list && list.tasks) {
                                        const taskExists = list.tasks.some(t => t.sharedTaskId === taskKey);
                                        if (!taskExists) {
                                            list.tasks.push({
                                                ...sharedTask,
                                                sharedTaskId: taskKey,
                                                isSharedTask: true
                                            });
                                        }
                                    }
                                }
                            });
                        }
                        
                        updateStats();
                        renderLists();
                    });
                });
            });
        }

        function updateStats() {
            let total = 0;
            let completed = 0;
            let overdue = 0;
            const now = new Date();

            lists.forEach(list => {
                if (list.tasks) {
                    total += list.tasks.length;
                    list.tasks.forEach(task => {
                        if (task.completed) completed++;
                        if (task.deadline && !task.completed && new Date(task.deadline) < now) {
                            overdue++;
                        }
                    });
                }
            });

            const pending = total - completed;
            const rate = total > 0 ? Math.round((completed / total) * 100) : 0;

            document.getElementById('totalTasks').textContent = total;
            document.getElementById('completedTasks').textContent = completed;
            document.getElementById('pendingTasks').textContent = pending;
            document.getElementById('overdueTasks').textContent = overdue;
            document.getElementById('completionRate').textContent = rate + '%';
        }

        function getPermission(list) {
            if (!isOnlineMode) return 'manager';
            if (!currentUser) return 'viewer';
            if (list.owner === currentUser.uid) return 'manager';
            
            if (list.sharedWith && list.sharedWith[currentUser.email.replace(/\./g, '_')]) {
                return list.sharedWith[currentUser.email.replace(/\./g, '_')];
            }
            
            return 'viewer';
        }

        function getTaskPermission(task) {
            if (!isOnlineMode) return 'manager';
            if (!currentUser) return 'viewer';
            if (task.createdBy === currentUser.uid) return 'manager';
            
            if (task.isSharedTask && task.sharedWith && task.sharedWith[currentUser.email.replace(/\./g, '_')]) {
                return task.sharedWith[currentUser.email.replace(/\./g, '_')];
            }
            
            return 'viewer';
        }

        function canEdit(perm) {
            return ['editor', 'manager'].includes(perm);
        }

        function canManage(perm) {
            return perm === 'manager';
        }

        function renderLists() {
            const container = document.getElementById('listsContainer');

            if (lists.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:60px;color:var(--text-secondary)"><div style="font-size:60px">üìù</div><p>Hozircha ro\'yxatlar yo\'q</p></div>';
                return;
            }

            container.innerHTML = '';

            lists.forEach(list => {
                const card = createListCard(list);
                container.appendChild(card);
            });
        }

        function createListCard(list) {
            const card = document.createElement('div');
            card.className = `list-card ${list.isShared ? 'shared' : ''}`;

            const permission = getPermission(list);
            const filteredTasks = filterTasks(list.tasks || []);

            const sortedTasks = filteredTasks.sort((a, b) => {
                if (a.completed === b.completed) return 0;
                return a.completed ? 1 : -1;
            });

            const tagsHTML = list.tags ? list.tags.map(tag => 
                `<span class="tag">${sanitizeInput(tag)} ${canManage(permission) ? `<span class="tag-remove" onclick="removeListTag('${list.id}', '${tag}', ${list.isShared})">√ó</span>` : ''}</span>`
            ).join('') : '';

            card.innerHTML = `
                <div class="list-header">
                    <input type="text" class="list-title-edit" value="${sanitizeInput(list.title)}" 
                        ${canManage(permission) ? '' : 'readonly'} 
                        onblur="updateListTitle('${list.id}', this.value, ${list.isShared})">
                    <div class="list-actions">
                        ${canManage(permission) ? `
                            <button class="icon-btn" onclick="openTagModal('${list.id}', ${list.isShared})" title="Teglar">üè∑Ô∏è</button>
                            <button class="icon-btn" onclick="duplicateList('${list.id}')" title="Nusxa olish">üìã</button>
                            <button class="icon-btn delete-list-btn" onclick="deleteList('${list.id}', ${list.isShared})">üóëÔ∏è</button>
                        ` : ''}
                    </div>
                </div>
                
                ${tagsHTML ? `<div class="tags-section">${tagsHTML}</div>` : ''}
                
                ${canManage(permission) ? `
                <div class="task-input-section">
                    <div class="task-input-row">
                        <input type="text" class="task-input" id="taskInput${list.id}" placeholder="Yangi vazifa...">
                        <input type="date" class="deadline-input" id="deadlineInput${list.id}">
                        <select class="recurring-select" id="recurringSelect${list.id}">
                            <option value="">Bir marta</option>
                            <option value="daily">Har kuni</option>
                            <option value="weekly">Har hafta</option>
                            <option value="monthly">Har oy</option>
                        </select>
                    </div>
                    <button class="add-task-btn" onclick="addTask('${list.id}', ${list.isShared})">+ Qo'shish</button>
                </div>` : ''}
                
                <ul class="tasks-list" id="tasksList${list.id}"></ul>
                
                ${canManage(permission) && list.isShared ? `
                <div class="share-section">
                    <strong>üë• Ro'yxatni ulashish:</strong>
                    <div class="permission-info">
                        <div class="permission-info-item">üëÅÔ∏è <strong>Kuzatuvchi:</strong> Faqat ko'rish</div>
                        <div class="permission-info-item">‚úèÔ∏è <strong>Tahrirlovchi:</strong> Vazifalarni belgilash, fayl yuklash, komment</div>
                        <div class="permission-info-item">‚öôÔ∏è <strong>Boshqaruvchi:</strong> To'liq nazorat</div>
                    </div>
                    <div class="share-input-group">
                        <input type="email" class="share-email-input" id="shareEmail${list.id}" placeholder="Email">
                        <select class="permission-select" id="sharePerm${list.id}">
                            <option value="viewer">Kuzatuvchi</option>
                            <option value="editor">Tahrirlovchi</option>
                            <option value="manager">Boshqaruvchi</option>
                        </select>
                        <button class="share-btn" onclick="shareList('${list.id}')">Ulashish</button>
                    </div>
                    <div class="shared-users" id="sharedUsers${list.id}"></div>
                </div>` : ''}
            `;

            const tasksList = card.querySelector(`#tasksList${list.id}`);
            sortedTasks.forEach((task, index) => {
                const taskItem = createTaskItem(task, index, list.id, list.isShared, permission);
                tasksList.appendChild(taskItem);
            });

            if (list.isShared && list.sharedWith) {
                setTimeout(() => renderSharedUsers(list), 0);
            }

            return card;
        }

        function createTaskItem(task, index, listId, isShared, listPermission) {
            const li = document.createElement('li');
            const taskPermission = task.isSharedTask ? getTaskPermission(task) : listPermission;
            
            li.className = `task-item ${task.completed ? 'completed' : ''} priority-${task.priority || 'medium'} ${task.recurring ? 'recurring' : ''}`;

            const now = new Date();
            const deadline = task.deadline ? new Date(task.deadline) : null;
            const isOverdue = deadline && deadline < now && !task.completed;

            const subtasksHTML = task.subtasks ? task.subtasks.map((subtask, subIndex) => `
                <div class="subtask-item ${subtask.completed ? 'completed' : ''}">
                    <div class="subtask-checkbox" ${canEdit(taskPermission) ? `onclick="toggleSubtask('${listId}', ${index}, ${subIndex}, ${isShared})"` : ''}></div>
                    <span class="subtask-text">${sanitizeInput(subtask.text)}</span>
                    ${canEdit(taskPermission) ? `<button class="delete-task-btn" onclick="deleteSubtask('${listId}', ${index}, ${subIndex}, ${isShared})" style="font-size:10px;padding:2px 6px">√ó</button>` : ''}
                </div>
            `).join('') : '';

            const commentsHTML = task.comments ? task.comments.map(comment => `
                <div class="comment-item">
                    <div class="comment-header">
                        <span class="comment-author">${sanitizeInput(comment.author)}</span>
                        <span class="comment-time">${formatDateTime(comment.timestamp)}</span>
                    </div>
                    <div class="comment-text">${sanitizeInput(comment.text)}</div>
                </div>
            `).join('') : '';

            const sharedTaskUsers = task.isSharedTask && task.sharedWith ? Object.keys(task.sharedWith).map(email => {
                const perm = task.sharedWith[email];
                return `
                    <div class="shared-user-item">
                        <span>${sanitizeInput(email.replace(/_/g, '.'))}</span>
                        <span class="permission-badge perm-${perm}">
                            ${perm === 'viewer' ? 'üëÅÔ∏è Kuzatuvchi' : perm === 'editor' ? '‚úèÔ∏è Tahrirlovchi' : '‚öôÔ∏è Boshqaruvchi'}
                        </span>
                    </div>
                `;
            }).join('') : '';

            li.innerHTML = `
                <div class="task-header">
                    <div class="checkbox" ${canEdit(taskPermission) ? `onclick="toggleTask('${listId}', ${index}, ${isShared})"` : ''}></div>
                    <div class="task-content">
                        <input type="text" class="task-text-edit" value="${sanitizeInput(task.text)}" 
                            ${canManage(taskPermission) ? '' : 'readonly'}
                            onblur="updateTaskText('${listId}', ${index}, this.value, ${isShared})">
                        <div class="task-meta">
                            ${task.deadline ? `<span class="task-deadline ${isOverdue ? 'overdue' : ''}">üìÖ ${formatDate(task.deadline)} ${isOverdue ? '‚ö†Ô∏è' : ''}</span>` : ''}
                            ${task.fileName ? `<a href="${task.fileUrl}" class="task-file" target="_blank">üìé ${sanitizeInput(task.fileName)}</a>` : ''}
                            ${task.timeSpent ? `<span class="task-time-spent">‚è±Ô∏è ${formatTime(task.timeSpent)}</span>` : ''}
                            ${task.recurring ? `<span style="color:var(--info)">üîÑ ${task.recurring === 'daily' ? 'Har kuni' : task.recurring === 'weekly' ? 'Har hafta' : 'Har oy'}</span>` : ''}
                            ${task.isSharedTask ? `<span style="color:var(--success);font-weight:600">üë• Ulashilgan vazifa</span>` : ''}
                        </div>
                        
                        ${subtasksHTML || canManage(taskPermission) ? `
                        <div class="subtasks-section">
                            ${subtasksHTML}
                            ${canManage(taskPermission) ? `
                            <div class="subtask-input-wrapper">
                                <input type="text" class="subtask-input" id="subtaskInput${listId}${index}" placeholder="Quyi vazifa...">
                                <button class="comment-btn" onclick="addSubtask('${listId}', ${index}, ${isShared})">+</button>
                            </div>` : ''}
                        </div>` : ''}
                        
                        ${commentsHTML || canEdit(taskPermission) ? `
                        <div class="comments-section">
                            <strong style="font-size:12px">üí¨ Izohlar:</strong>
                            ${commentsHTML}
                            ${canEdit(taskPermission) ? `
                            <div class="comment-input-wrapper">
                                <input type="text" class="comment-input" id="commentInput${listId}${index}" placeholder="Izoh...">
                                <button class="comment-btn" onclick="addComment('${listId}', ${index}, ${isShared})">Yuborish</button>
                            </div>` : ''}
                        </div>` : ''}

                        ${canManage(taskPermission) && !task.isSharedTask ? `
                        <div class="share-task-section">
                            <div class="share-task-header">
                                <strong style="font-size:12px">üë• Vazifani ulashish:</strong>
                            </div>
                            <div class="share-input-group">
                                <input type="email" class="share-email-input" id="shareTaskEmail${listId}${index}" placeholder="Email" style="font-size:11px;padding:6px">
                                <select class="permission-select" id="shareTaskPerm${listId}${index}" style="font-size:11px;padding:6px">
                                    <option value="viewer">Kuzatuvchi</option>
                                    <option value="editor">Tahrirlovchi</option>
                                    <option value="manager">Boshqaruvchi</option>
                                </select>
                                <button class="share-btn" onclick="shareTask('${listId}', ${index})" style="font-size:11px;padding:6px 12px">Ulashish</button>
                            </div>
                            ${sharedTaskUsers ? `<div class="shared-users">${sharedTaskUsers}</div>` : ''}
                        </div>` : ''}
                    </div>
                </div>
                <div class="task-actions">
                    ${canManage(taskPermission) ? `
                    <select class="priority-select priority-${task.priority || 'medium'}" onchange="updateTaskPriority('${listId}', ${index}, this.value, ${isShared})">
                        <option value="low" ${task.priority === 'low' ? 'selected' : ''}>Past</option>
                        <option value="medium" ${!task.priority || task.priority === 'medium' ? 'selected' : ''}>O'rta</option>
                        <option value="high" ${task.priority === 'high' ? 'selected' : ''}>Yuqori</option>
                        <option value="critical" ${task.priority === 'critical' ? 'selected' : ''}>Kritik</option>
                    </select>` : ''}
                    <select class="status-select status-${task.status || 'todo'}" ${canManage(taskPermission) ? '' : 'disabled'} onchange="updateTaskStatus('${listId}', ${index}, this.value, ${isShared})">
                        <option value="backlog" ${task.status === 'backlog' ? 'selected' : ''}>Backlog</option>
                        <option value="todo" ${!task.status || task.status === 'todo' ? 'selected' : ''}>To Do</option>
                        <option value="progress" ${task.status === 'progress' ? 'selected' : ''}>In Progress</option>
                        <option value="review" ${task.status === 'review' ? 'selected' : ''}>Review</option>
                        <option value="done" ${task.status === 'done' ? 'selected' : ''}>Done</option>
                    </select>
                    ${canEdit(taskPermission) ? `
                    <label class="file-input-label" id="fileLabel${listId}${index}">
                        üìé Fayl
                        <input type="file" class="file-input" onchange="uploadFile('${listId}', ${index}, this, ${isShared})" accept="image/*,video/*,.pdf,.doc,.docx">
                    </label>
                    <button class="timer-btn ${timers[listId + '_' + index] ? 'running' : ''}" id="timerBtn${listId}${index}" onclick="toggleTimer('${listId}', ${index}, ${isShared})">
                        ${timers[listId + '_' + index] ? '‚è∏Ô∏è To\'xtatish' : '‚ñ∂Ô∏è Boshlash'}
                    </button>` : ''}
                    ${canManage(taskPermission) ? `<button class="delete-task-btn" onclick="deleteTask('${listId}', ${index}, ${isShared})">üóëÔ∏è</button>` : ''}
                </div>
            `;

            return li;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const taskDate = new Date(date);
            taskDate.setHours(0, 0, 0, 0);

            const diff = (taskDate - today) / (1000 * 60 * 60 * 24);

            if (diff === 0) return 'Bugun';
            if (diff === 1) return 'Ertaga';
            if (diff === -1) return 'Kecha';
            
            return date.toLocaleDateString('uz-UZ', { day: 'numeric', month: 'short' });
        }

        function formatDateTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString('uz-UZ', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
        }

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours}s ${minutes}d`;
        }

        function renderSharedUsers(list) {
            const container = document.getElementById(`sharedUsers${list.id}`);
            if (!container || !list.sharedWith) return;

            container.innerHTML = '';
            Object.keys(list.sharedWith).forEach(email => {
                const perm = list.sharedWith[email];
                const div = document.createElement('div');
                div.className = 'shared-user-item';
                div.innerHTML = `
                    <span>${sanitizeInput(email.replace(/_/g, '.'))}</span>
                    <span class="permission-badge perm-${perm}">
                        ${perm === 'viewer' ? 'üëÅÔ∏è Kuzatuvchi' : perm === 'editor' ? '‚úèÔ∏è Tahrirlovchi' : '‚öôÔ∏è Boshqaruvchi'}
                    </span>
                `;
                container.appendChild(div);
            });
        }

        async function saveData(listId, isShared) {
            try {
                const list = lists.find(l => l.id === listId);
                if (!list) {
                    console.error('List not found in saveData:', listId);
                    return;
                }
                
                console.log('Saving list:', listId, 'isShared:', isShared, 'isOnlineMode:', isOnlineMode);
                
                if (isOnlineMode && currentUser) {
                    const path = isShared ? `sharedLists/${listId}` : `users/${currentUser.uid}/lists/${listId}`;
                    console.log('Saving to Firebase path:', path);
                    
                    await database.ref(path).set({
                        title: list.title,
                        tasks: list.tasks || [],
                        tags: list.tags || [],
                        owner: list.owner || currentUser.uid,
                        ownerName: list.ownerName || currentUser.displayName,
                        createdAt: list.createdAt || Date.now()
                    });
                    
                    console.log('Successfully saved to Firebase');
                } else {
                    console.log('Saving to local storage');
                    saveToLocal();
                }
                updateStats();
                renderLists();
            } catch (error) {
                console.error('Save data error:', error);
                showError('Saqlashda xatolik: ' + error.message);
            }
        }

        async function createList() {
            const input = document.getElementById('newListInput');
            const title = input.value.trim();

            if (!title) {
                showError('Ro\'yxat nomini kiriting');
                return;
            }

            try {
                showLoading(true);

                const newList = {
                    title: sanitizeInput(title),
                    tasks: [],
                    tags: [],
                    createdAt: Date.now()
                };

                if (isOnlineMode) {
                    newList.owner = currentUser.uid;
                    newList.ownerName = currentUser.displayName;
                    await database.ref(`users/${currentUser.uid}/lists`).push(newList);
                } else {
                    newList.id = 'list_' + Date.now();
                    lists.push(newList);
                    saveToLocal();
                    renderLists();
                }

                input.value = '';
                showSuccess('Ro\'yxat yaratildi');
            } catch (error) {
                showError('Yaratishda xatolik');
            } finally {
                showLoading(false);
            }
        }

        async function deleteList(listId, isShared) {
            if (!confirm('Rostdan ham o\'chirmoqchimisiz?')) return;
            
            try {
                showLoading(true);
                
                if (isOnlineMode) {
                    const path = isShared ? `sharedLists/${listId}` : `users/${currentUser.uid}/lists/${listId}`;
                    await database.ref(path).remove();
                } else {
                    lists = lists.filter(l => l.id !== listId);
                    saveToLocal();
                    renderLists();
                }
                
                showSuccess('Ro\'yxat o\'chirildi');
            } catch (error) {
                showError('O\'chirishda xatolik');
            } finally {
                showLoading(false);
            }
        }

        async function duplicateList(listId) {
            const list = lists.find(l => l.id === listId);
            if (!list) return;
            
            showLoading(true);
            
            const newList = {
                title: list.title + ' (Nusxa)',
                tasks: JSON.parse(JSON.stringify(list.tasks || [])),
                tags: JSON.parse(JSON.stringify(list.tags || [])),
                createdAt: Date.now()
            };
            
            try {
                if (isOnlineMode) {
                    newList.owner = currentUser.uid;
                    newList.ownerName = currentUser.displayName;
                    await database.ref(`users/${currentUser.uid}/lists`).push(newList);
                } else {
                    newList.id = 'list_' + Date.now();
                    lists.push(newList);
                    saveToLocal();
                    renderLists();
                }
                
                showSuccess('Nusxa olindi');
            } catch (error) {
                showError('Nusxa olishda xatolik');
            } finally {
                showLoading(false);
            }
        }

        async function updateListTitle(listId, newTitle, isShared) {
            const title = newTitle.trim();
            if (!title) {
                renderLists();
                return;
            }
            
            const list = lists.find(l => l.id === listId);
            if (!list) return;
            
            list.title = title;
            await saveData(listId, isShared);
        }

        function openTagModal(listId, isShared) {
            const list = lists.find(l => l.id === listId);
            if (!list) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">Teglar boshqaruvi</div>
                        <span class="modal-close" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div style="display:flex;gap:5px;margin-bottom:10px">
                            <input type="text" id="newTagInput" placeholder="Yangi teg..." style="flex:1;padding:8px;border:1px solid var(--border);border-radius:5px;background:var(--bg-card);color:var(--text-main)">
                            <button onclick="addListTag('${listId}', ${isShared})" style="padding:8px 15px;background:var(--primary);color:white;border:none;border-radius:5px;cursor:pointer">Qo'shish</button>
                        </div>
                        <div id="modalTags" class="tags-section">
                            ${list.tags ? list.tags.map(tag => `
                                <span class="tag">${sanitizeInput(tag)} 
                                    <span class="tag-remove" onclick="removeListTag('${listId}', '${tag}', ${isShared})">√ó</span>
                                </span>
                            `).join('') : '<p style="color:var(--text-secondary);font-size:13px">Hozircha teglar yo\'q</p>'}
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function addListTag(listId, isShared) {
            const input = document.getElementById('newTagInput');
            const tag = input.value.trim();
            
            if (!tag) return;
            
            const list = lists.find(l => l.id === listId);
            if (!list) return;
            
            if (!list.tags) list.tags = [];
            
            if (list.tags.includes(tag)) {
                showError('Bu teg allaqachon mavjud');
                return;
            }
            
            list.tags.push(tag);
            await saveData(listId, isShared);
            input.value = '';
            
            const modalTags = document.getElementById('modalTags');
            if (modalTags) {
                modalTags.innerHTML = list.tags.map(t => `
                    <span class="tag">${sanitizeInput(t)} 
                        <span class="tag-remove" onclick="removeListTag('${listId}', '${t}', ${isShared})">√ó</span>
                    </span>
                `).join('');
            }
            
            renderLists();
            showSuccess('Teg qo\'shildi');
        }

        async function removeListTag(listId, tag, isShared) {
            const list = lists.find(l => l.id === listId);
            if (!list || !list.tags) return;
            
            list.tags = list.tags.filter(t => t !== tag);
            await saveData(listId, isShared);
            
            const modalTags = document.getElementById('modalTags');
            if (modalTags) {
                modalTags.innerHTML = list.tags.length ? list.tags.map(t => `
                    <span class="tag">${sanitizeInput(t)} 
                        <span class="tag-remove" onclick="removeListTag('${listId}', '${t}', ${isShared})">√ó</span>
                    </span>
                `).join('') : '<p style="color:var(--text-secondary);font-size:13px">Hozircha teglar yo\'q</p>';
            }
            
            renderLists();
        }

        async function addTask(listId, isShared) {
            const input = document.getElementById(`taskInput${listId}`);
            const deadlineInput = document.getElementById(`deadlineInput${listId}`);
            const recurringSelect = document.getElementById(`recurringSelect${listId}`);
            const text = input.value.trim();
            
            if (!text) {
                showError('Vazifa matnini kiriting');
                return;
            }

            try {
                const list = lists.find(l => l.id === listId);
                if (!list) {
                    console.error('List not found:', listId);
                    showError('Ro\'yxat topilmadi');
                    return;
                }
                
                console.log('Adding task to list:', listId, 'Online mode:', isOnlineMode);
                
                if (!list.tasks) {
                    list.tasks = [];
                }
                
                const newTask = {
                    text: sanitizeInput(text),
                    completed: false,
                    status: 'todo',
                    priority: 'medium',
                    createdAt: Date.now(),
                    subtasks: [],
                    comments: []
                };

                if (isOnlineMode && currentUser) {
                    newTask.createdBy = currentUser.uid;
                }

                if (deadlineInput.value) {
                    newTask.deadline = deadlineInput.value;
                }
                
                if (recurringSelect.value) {
                    newTask.recurring = recurringSelect.value;
                }

                list.tasks.push(newTask);
                
                console.log('Task added to local array, now saving...');
                await saveData(listId, isShared);
                
                input.value = '';
                deadlineInput.value = '';
                recurringSelect.value = '';
                
                console.log('Task saved successfully');
                showSuccess('Vazifa qo\'shildi');
            } catch (error) {
                console.error('Add task error:', error);
                showError('Vazifa qo\'shishda xatolik: ' + error.message);
            }
        }

        async function updateTaskText(listId, index, newText, isShared) {
            const text = newText.trim();
            if (!text) {
                renderLists();
                return;
            }
            
            const list = lists.find(l => l.id === listId);
            if (!list || !list.tasks[index]) return;
            
            list.tasks[index].text = sanitizeInput(text);
            
            if (list.tasks[index].isSharedTask && list.tasks[index].sharedTaskId) {
                await database.ref(`sharedTasks/${list.tasks[index].sharedTaskId}/text`).set(sanitizeInput(text));
            }
            
            await saveData(listId, isShared);
        }

        async function toggleTask(listId, index, isShared) {
            const list = lists.find(l => l.id === listId);
            if (!list || !list.tasks[index]) return;
            
            const task = list.tasks[index];
            task.completed = !task.completed;
            
            if (task.recurring && task.completed) {
                task.lastCompletedDate = Date.now();
            }
            
            const timerKey = listId + '_' + index;
            if (timers[timerKey]) {
                clearInterval(timers[timerKey].interval);
                delete timers[timerKey];
            }
            
            if (task.isSharedTask && task.sharedTaskId) {
                await database.ref(`sharedTasks/${task.sharedTaskId}/completed`).set(task.completed);
            }
            
            await saveData(listId, isShared);
            renderLists();
            
            if (task.completed) {
                showSuccess('Vazifa bajarildi! üéâ');
            }
        }

        async function updateTaskStatus(listId, index, status, isShared) {
            const list = lists.find(l => l.id === listId);
            if (!list || !list.tasks[index]) return;
            
            list.tasks[index].status = status;
            
            if (list.tasks[index].isSharedTask && list.tasks[index].sharedTaskId) {
                await database.ref(`sharedTasks/${list.tasks[index].sharedTaskId}/status`).set(status);
            }
            
            await saveData(listId, isShared);
        }

        async function updateTaskPriority(listId, index, priority, isShared) {
            const list = lists.find(l => l.id === listId);
            if (!list || !list.tasks[index]) return;
            
            list.tasks[index].priority = priority;
            
            if (list.tasks[index].isSharedTask && list.tasks[index].sharedTaskId) {
                await database.ref(`sharedTasks/${list.tasks[index].sharedTaskId}/priority`).set(priority);
            }
            
            await saveData(listId, isShared);
            renderLists();
        }

        async function deleteTask(listId, index, isShared) {
            if (!confirm('Bu vazifani o\'chirmoqchimisiz?')) return;
            
            const list = lists.find(l => l.id === listId);
            if (!list) return;
            
            const task = list.tasks[index];
            
            const timerKey = listId + '_' + index;
            if (timers[timerKey]) {
                clearInterval(timers[timerKey].interval);
                delete timers[timerKey];
            }
            
            if (task.isSharedTask && task.sharedTaskId) {
                await database.ref(`sharedTasks/${task.sharedTaskId}`).remove();
            }
            
            list.tasks.splice(index, 1);
            await saveData(listId, isShared);
            renderLists();
            showSuccess('Vazifa o\'chirildi');
        }

        async function addSubtask(listId, index, isShared) {
            const input = document.getElementById(`subtaskInput${listId}${index}`);
            const text = input.value.trim();
            
            if (!text) return;
            
            const list = lists.find(l => l.id === listId);
            if (!list || !list.tasks[index]) return;
            
            if (!list.tasks[index].subtasks) {
                list.tasks[index].subtasks = [];
            }
            
            list.tasks[index].subtasks.push({
                text: sanitizeInput(text),
                completed: false,
                createdAt: Date.now()
            });
            
            if (list.tasks[index].isSharedTask && list.tasks[index].sharedTaskId) {
                await database.ref(`sharedTasks/${list.tasks[index].sharedTaskId}/subtasks`).set(list.tasks[index].subtasks);
            }
            
            await saveData(listId, isShared);
            input.value = '';
            renderLists();
            showSuccess('Quyi vazifa qo\'shildi');
        }

        async function toggleSubtask(listId, index, subIndex, isShared) {
            const list = lists.find(l => l.id === listId);
            if (!list || !list.tasks[index] || !list.tasks[index].subtasks[subIndex]) return;
            
            list.tasks[index].subtasks[subIndex].completed = !list.tasks[index].subtasks[subIndex].completed;
            
            if (list.tasks[index].isSharedTask && list.tasks[index].sharedTaskId) {
                await database.ref(`sharedTasks/${list.tasks[index].sharedTaskId}/subtasks`).set(list.tasks[index].subtasks);
            }
            
            await saveData(listId, isShared);
            renderLists();
        }

        async function deleteSubtask(listId, index, subIndex, isShared) {
            const list = lists.find(l => l.id === listId);
            if (!list || !list.tasks[index]) return;
            
            list.tasks[index].subtasks.splice(subIndex, 1);
            
            if (list.tasks[index].isSharedTask && list.tasks[index].sharedTaskId) {
                await database.ref(`sharedTasks/${list.tasks[index].sharedTaskId}/subtasks`).set(list.tasks[index].subtasks);
            }
            
            await saveData(listId, isShared);
            renderLists();
        }

        async function addComment(listId, index, isShared) {
            const input = document.getElementById(`commentInput${listId}${index}`);
            const text = input.value.trim();
            
            if (!text) return;
            
            const list = lists.find(l => l.id === listId);
            if (!list || !list.tasks[index]) return;
            
            if (!list.tasks[index].comments) {
                list.tasks[index].comments = [];
            }
            
            list.tasks[index].comments.push({
                text: sanitizeInput(text),
                author: currentUser ? currentUser.displayName : 'Foydalanuvchi',
                timestamp: Date.now()
            });
            
            if (list.tasks[index].isSharedTask && list.tasks[index].sharedTaskId) {
                await database.ref(`sharedTasks/${list.tasks[index].sharedTaskId}/comments`).set(list.tasks[index].comments);
            }
            
            await saveData(listId, isShared);
            input.value = '';
            renderLists();
            showSuccess('Izoh qo\'shildi');
        }

        function toggleTimer(listId, index, isShared) {
            const timerKey = listId + '_' + index;
            const btn = document.getElementById(`timerBtn${listId}${index}`);
            
            if (timers[timerKey]) {
                clearInterval(timers[timerKey].interval);
                const timeSpent = timers[timerKey].elapsed;
                delete timers[timerKey];
                
                const list = lists.find(l => l.id === listId);
                if (list && list.tasks[index]) {
                    if (!list.tasks[index].timeSpent) {
                        list.tasks[index].timeSpent = 0;
                    }
                    list.tasks[index].timeSpent += timeSpent;
                    saveData(listId, isShared);
                }
                
                btn.textContent = '‚ñ∂Ô∏è Boshlash';
                btn.classList.remove('running');
                renderLists();
                showSuccess('Vaqt saqlandi');
            } else {
                timers[timerKey] = {
                    startTime: Date.now(),
                    elapsed: 0,
                    interval: setInterval(() => {
                        timers[timerKey].elapsed = Math.floor((Date.now() - timers[timerKey].startTime) / 1000);
                    }, 1000)
                };
                
                btn.textContent = '‚è∏Ô∏è To\'xtatish';
                btn.classList.add('running');
            }
        }

        async function uploadFile(listId, index, input, isShared) {
            const file = input.files[0];
            if (!file) return;

            if (file.size > 10 * 1024 * 1024) {
                showError('Fayl hajmi 10MB dan kichik bo\'lishi kerak!');
                input.value = '';
                return;
            }

            const label = document.getElementById(`fileLabel${listId}${index}`);
            
            try {
                label.classList.add('uploading');
                label.textContent = 'Yuklanmoqda...';
                
                const list = lists.find(l => l.id === listId);
                if (!list || !list.tasks[index]) return;
                
                if (isOnlineMode) {
                    const timestamp = Date.now();
                    const safeName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_').substring(0, 100);
                    const fileName = `${timestamp}_${safeName}`;
                    const filePath = `files/${currentUser.uid}/${fileName}`;
                    
                    const storageRef = storage.ref(filePath);
                    const uploadTask = storageRef.put(file);
                    
                    uploadTask.on('state_changed', 
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            label.textContent = `${Math.round(progress)}%`;
                        },
                        (error) => {
                            showError('Fayl yuklashda xatolik');
                            label.classList.remove('uploading');
                            label.textContent = 'üìé Fayl';
                        },
                        async () => {
                            const url = await uploadTask.snapshot.ref.getDownloadURL();
                            
                            list.tasks[index].fileUrl = url;
                            list.tasks[index].fileName = file.name;
                            
                            if (list.tasks[index].isSharedTask && list.tasks[index].sharedTaskId) {
                                await database.ref(`sharedTasks/${list.tasks[index].sharedTaskId}/fileUrl`).set(url);
                                await database.ref(`sharedTasks/${list.tasks[index].sharedTaskId}/fileName`).set(file.name);
                            }
                            
                            await saveData(listId, isShared);
                            renderLists();
                            showSuccess('Fayl yuklandi!');
                        }
                    );
                } else {
                    if (file.size > 5 * 1024 * 1024) {
                        showError('Offline rejimda fayl hajmi 5MB dan kichik bo\'lishi kerak!');
                        input.value = '';
                        label.classList.remove('uploading');
                        label.textContent = 'üìé Fayl';
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        list.tasks[index].fileUrl = e.target.result;
                        list.tasks[index].fileName = file.name;
                        saveToLocal();
                        renderLists();
                        showSuccess('Fayl yuklandi (offline)');
                    };
                    reader.readAsDataURL(file);
                }
            } catch (error) {
                showError('Fayl yuklashda xatolik');
            } finally {
                setTimeout(() => {
                    if (label) {
                        label.classList.remove('uploading');
                        label.textContent = 'üìé Fayl';
                    }
                }, 500);
                input.value = '';
            }
        }

        async function shareList(listId) {
            const emailInput = document.getElementById(`shareEmail${listId}`);
            const email = emailInput.value.trim();
            const permission = document.getElementById(`sharePerm${listId}`).value;

            if (!email) {
                showError('Email manzilini kiriting');
                return;
            }

            if (!validateEmail(email)) {
                showError('Email manzili noto\'g\'ri');
                return;
            }

            if (email === currentUser.email) {
                showError('O\'zingizga ulasha olmaysiz');
                return;
            }

            try {
                await database.ref(`sharedLists/${listId}/sharedWith/${email.replace(/\./g, '_')}`).set(permission);
                emailInput.value = '';
                showSuccess('Ro\'yxat ulashildi');
            } catch (error) {
                showError('Ulashishda xatolik');
            }
        }

        async function shareTask(listId, index) {
            const emailInput = document.getElementById(`shareTaskEmail${listId}${index}`);
            const email = emailInput.value.trim();
            const permission = document.getElementById(`shareTaskPerm${listId}${index}`).value;

            if (!email) {
                showError('Email manzilini kiriting');
                return;
            }

            if (!validateEmail(email)) {
                showError('Email manzili noto\'g\'ri');
                return;
            }

            if (email === currentUser.email) {
                showError('O\'zingizga ulasha olmaysiz');
                return;
            }

            try {
                const list = lists.find(l => l.id === listId);
                if (!list || !list.tasks[index]) return;
                
                const task = list.tasks[index];
                
                const sharedTaskData = {
                    ...task,
                    listId: listId,
                    owner: currentUser.uid,
                    ownerName: currentUser.displayName,
                    sharedWith: {
                        [email.replace(/\./g, '_')]: permission
                    }
                };
                
                const sharedTaskRef = await database.ref('sharedTasks').push(sharedTaskData);
                
                list.tasks[index].isSharedTask = true;
                list.tasks[index].sharedTaskId = sharedTaskRef.key;
                list.tasks[index].sharedWith = sharedTaskData.sharedWith;
                
                await saveData(listId, list.isShared);
                emailInput.value = '';
                renderLists();
                showSuccess('Vazifa ulashildi!');
            } catch (error) {
                console.error('Share task error:', error);
                showError('Vazifani ulashishda xatolik');
            }
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthTitle = document.getElementById('calendarMonth');
            
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            monthTitle.textContent = currentCalendarDate.toLocaleDateString('uz-UZ', { year: 'numeric', month: 'long' });
            
            grid.innerHTML = '';
            
            const days = ['Du', 'Se', 'Ch', 'Pa', 'Ju', 'Sh', 'Ya'];
            days.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                grid.appendChild(header);
            });
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const prevLastDay = new Date(year, month, 0);
            
            const firstDayIndex = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
            const lastDayDate = lastDay.getDate();
            const prevLastDayDate = prevLastDay.getDate();
            
            const today = new Date();
            
            for (let i = firstDayIndex; i > 0; i--) {
                const day = document.createElement('div');
                day.className = 'calendar-day other-month';
                day.innerHTML = `<div class="calendar-day-number">${prevLastDayDate - i + 1}</div>`;
                grid.appendChild(day);
            }
            
            for (let i = 1; i <= lastDayDate; i++) {
                const day = document.createElement('div');
                const currentDate = new Date(year, month, i);
                
                day.className = 'calendar-day';
                if (currentDate.toDateString() === today.toDateString()) {
                    day.classList.add('today');
                }
                
                let tasksHTML = '';
                lists.forEach(list => {
                    if (!list.tasks) return;
                    list.tasks.forEach(task => {
                        if (task.deadline) {
                            const deadline = new Date(task.deadline);
                            if (deadline.toDateString() === currentDate.toDateString()) {
                                tasksHTML += `<div class="calendar-task-item" title="${task.text}">${task.text}</div>`;
                            }
                        }
                    });
                });
                
                day.innerHTML = `<div class="calendar-day-number">${i}</div>${tasksHTML}`;
                grid.appendChild(day);
            }
            
            const totalCells = firstDayIndex + lastDayDate;
            const remainingCells = 42 - totalCells;
            for (let i = 1; i <= remainingCells; i++) {
                const day = document.createElement('div');
                day.className = 'calendar-day other-month';
                day.innerHTML = `<div class="calendar-day-number">${i}</div>`;
                grid.appendChild(day);
            }
        }

        function previousMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
        }

        function currentMonth() {
            currentCalendarDate = new Date();
            renderCalendar();
        }

        function nextMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
        }

        function renderAnalytics() {
            renderActivityChart();
            renderPriorityChart();
            renderCompletionStats();
        }

        function renderActivityChart() {
            const ctx = document.getElementById('activityChart');
            if (!ctx) return;
            
            if (activityChart) activityChart.destroy();
            
            const days = [];
            const completedData = [];
            const createdData = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                days.push(date.toLocaleDateString('uz-UZ', { weekday: 'short' }));
                
                let completed = 0;
                let created = 0;
                
                lists.forEach(list => {
                    if (!list.tasks) return;
                    list.tasks.forEach(task => {
                        const taskDate = new Date(task.createdAt);
                        if (taskDate.toDateString() === date.toDateString()) {
                            created++;
                        }
                        if (task.completed && task.lastCompletedDate) {
                            const completedDate = new Date(task.lastCompletedDate);
                            if (completedDate.toDateString() === date.toDateString()) {
                                completed++;
                            }
                        }
                    });
                });
                
                completedData.push(completed);
                createdData.push(created);
            }
            
            activityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: days,
                    datasets: [{
                        label: 'Yaratilgan',
                        data: createdData,
                        borderColor: 'rgb(102, 126, 234)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.3
                    }, {
                        label: 'Bajarilgan',
                        data: completedData,
                        borderColor: 'rgb(40, 167, 69)',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
        }

        function renderPriorityChart() {
            const ctx = document.getElementById('priorityChart');
            if (!ctx) return;
            
            if (priorityChart) priorityChart.destroy();
            
            const priorities = { low: 0, medium: 0, high: 0, critical: 0 };
            
            lists.forEach(list => {
                if (!list.tasks) return;
                list.tasks.forEach(task => {
                    if (!task.completed) {
                        const priority = task.priority || 'medium';
                        priorities[priority]++;
                    }
                });
            });
            
            priorityChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Past', 'O\'rta', 'Yuqori', 'Kritik'],
                    datasets: [{
                        data: [priorities.low, priorities.medium, priorities.high, priorities.critical],
                        backgroundColor: [
                            'rgb(108, 117, 125)',
                            'rgb(255, 193, 7)',
                            'rgb(255, 107, 53)',
                            'rgb(220, 53, 69)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }

        function renderCompletionStats() {
            const container = document.getElementById('completionStats');
            if (!container) return;
            
            let totalTime = 0;
            let avgCompletionTime = 0;
            let completedCount = 0;
            
            lists.forEach(list => {
                if (!list.tasks) return;
                list.tasks.forEach(task => {
                    if (task.timeSpent) {
                        totalTime += task.timeSpent;
                    }
                    if (task.completed && task.createdAt && task.lastCompletedDate) {
                        const time = (task.lastCompletedDate - task.createdAt) / (1000 * 60 * 60 * 24);
                        avgCompletionTime += time;
                        completedCount++;
                    }
                });
            });
            
            avgCompletionTime = completedCount > 0 ? avgCompletionTime / completedCount : 0;
            
            container.innerHTML = `
                <div class="stats-bar">
                    <div class="stat-card">
                        <div class="stat-number">${formatTime(totalTime)}</div>
                        <div class="stat-label">Jami sarflangan vaqt</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${avgCompletionTime.toFixed(1)} kun</div>
                        <div class="stat-label">O'rtacha bajarilish vaqti</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${lists.length}</div>
                        <div class="stat-label">Ro'yxatlar soni</div>
                    </div>
                </div>
            `;
        }

        function renderTemplates() {
            const container = document.getElementById('templatesContainer');
            if (!container) return;
            
            container.innerHTML = templates.map((template, index) => `
                <div class="template-card" onclick="useTemplate(${index})">
                    <div class="template-title">${template.title}</div>
                    <div class="template-description">${template.description}</div>
                    <div style="margin-top: 10px; font-size: 12px; color: var(--text-secondary);">
                        ${template.tasks.length} ta vazifa
                    </div>
                </div>
            `).join('');
        }

        async function useTemplate(index) {
            const template = templates[index];
            if (!template) return;
            
            try {
                showLoading(true);
                
                const newList = {
                    title: template.title,
                    tasks: JSON.parse(JSON.stringify(template.tasks)),
                    tags: [],
                    createdAt: Date.now()
                };
                
                newList.tasks = newList.tasks.map(task => ({
                    ...task,
                    completed: false,
                    subtasks: [],
                    comments: [],
                    createdAt: Date.now()
                }));
                
                if (isOnlineMode) {
                    newList.owner = currentUser.uid;
                    newList.ownerName = currentUser.displayName;
                    await database.ref(`users/${currentUser.uid}/lists`).push(newList);
                } else {
                    newList.id = 'list_' + Date.now();
                    lists.push(newList);
                    saveToLocal();
                    renderLists();
                }
                
                switchTab('lists');
                showSuccess('Shablon qo\'llanildi!');
            } catch (error) {
                showError('Shablon yaratishda xatolik');
            } finally {
                showLoading(false);
            }
        }

        function openImportModal() {
            document.getElementById('importModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        async function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showError('Faylni tanlang');
                return;
            }
            
            try {
                showLoading(true);
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (!Array.isArray(data)) {
                            showError('Fayl formati noto\'g\'ri');
                            return;
                        }
                        
                        for (const list of data) {
                            if (isOnlineMode) {
                                await database.ref(`users/${currentUser.uid}/lists`).push({
                                    ...list,
                                    owner: currentUser.uid,
                                    ownerName: currentUser.displayName,
                                    importedAt: Date.now()
                                });
                            } else {
                                list.id = 'list_' + Date.now() + '_' + Math.random();
                                lists.push(list);
                            }
                        }
                        
                        if (!isOnlineMode) {
                            saveToLocal();
                            renderLists();
                        }
                        
                        closeModal('importModal');
                        showSuccess(`${data.length} ta ro'yxat import qilindi!`);
                    } catch (error) {
                        showError('Faylni o\'qishda xatolik');
                    } finally {
                        showLoading(false);
                    }
                };
                reader.readAsText(file);
            } catch (error) {
                showError('Import qilishda xatolik');
                showLoading(false);
            }
        }

        function exportAllData() {
            try {
                const dataToExport = lists.map(list => ({
                    title: list.title,
                    tasks: list.tasks || [],
                    tags: list.tags || [],
                    createdAt: list.createdAt
                }));
                
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `checkbox_task_backup_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
                showSuccess('Ma\'lumotlar eksport qilindi!');
            } catch (error) {
                showError('Eksport qilishda xatolik');
            }
        }

        document.getElementById('newListBtn').addEventListener('click', createList);
        
        document.getElementById('newListInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') createList();
        });

        window.addEventListener('online', () => {
            if (currentUser && !isOnlineMode) {
                showSuccess('Internet aloqasi qayta ulandi');
                isOnlineMode = true;
                syncLocalToFirebase();
            }
        });

        window.addEventListener('offline', () => {
            if (isOnlineMode) {
                showNotification('Internet aloqasi yo\'q. Offline rejimda ishlayapsiz.', 'warning', 5000);
                isOnlineMode = false;
            }
        });

        console.log('‚úÖ CheckBox Task yuklandi');
    </script>
</body>
</html>
